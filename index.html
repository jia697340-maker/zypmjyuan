<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>章鱼喷墨机（粘包狗版本）</title>
    
    <!-- ▼▼▼ PWA全屏安装配置 ▼▼▼ -->
    <!-- 1. (核心) 为苹果设备设置主屏幕图标 -->
    <link rel="apple-touch-icon" href="https://i.postimg.cc/mZ6N4GtT/mmexport1762250594890.jpg">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.postimg.cc/mZ6N4GtT/mmexport1762250594890.jpg">
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.postimg.cc/mZ6N4GtT/mmexport1762250594890.jpg">
    <link rel="apple-touch-icon" sizes="167x167" href="https://i.postimg.cc/mZ6N4GtT/mmexport1762250594890.jpg">
    
    <!-- 2. (核心) 告诉苹果设备，这是一个Web应用，可以全屏显示 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- 3. (核心) 设置苹果设备全屏模式下的状态栏样式 -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- 4. (可选) 设置应用在主屏幕上显示的标题 -->
    <meta name="apple-mobile-web-app-title" content="章鱼喷墨机">
    
    <!-- 5. (兼容) 为部分安卓浏览器提供支持 -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- 6. (备用) 标准浏览器页签图标 -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/mZ6N4GtT/mmexport1762250594890.jpg">
    
    <!-- 7. (核心) 链接到manifest文件，支持PWA安装 -->
    <link rel="manifest" href="manifest.json">
    <!-- ▲▲▲ PWA配置结束 ▲▲▲ -->
    <!-- 版本: 2025-12-10-fix-regenerate-and-npc -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>

        <link rel="stylesheet" href="style.css">

</head>

<body>
<!-- 页面动态效果容器 -->
<div id="page-effect-container"></div>

    <div class="phone-screen">
        <!-- 顶部状态栏 -->
        <div id="status-bar" style="display: none;">
            <div class="status-bar-time" id="status-bar-time">--:--</div>
            <div class="status-bar-right">
                <div class="status-bar-battery" id="status-bar-battery">
                    <svg class="charging-icon" id="charging-icon" style="display: none;" viewBox="0 0 12 18" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7 0L3 10h3l-1 8 8-11h-4l2-7z"/>
                    </svg>
                    <span class="battery-percentage" id="battery-percentage">100%</span>
                    <svg class="battery-icon" viewBox="0 0 30 15" xmlns="http://www.w3.org/2000/svg">
                        <rect class="battery-outline" x="0" y="0" width="26" height="15" rx="5" ry="5"/>
                        <rect class="battery-level" id="battery-level" x="2" y="2" width="0" height="11" rx="3" ry="3"/>
                        <rect class="battery-tip" x="26" y="5" width="4" height="5" rx="2.5" ry="2.5"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- 锁屏界面 -->
        <div id="lock-screen">
            <div class="lock-time" id="lock-time">12:00</div>
            <div class="lock-date" id="lock-date">1月1日 星期一</div>
            
            <!-- 无密码/上滑解锁 -->
            <div id="unlock-swipe" class="unlock-indicator">
                <div class="unlock-arrow">↑</div>
                <div class="unlock-text" id="unlock-text">上滑解锁 / 按↑键解锁</div>
            </div>
            
            <!-- 数字密码解锁 -->
            <div id="unlock-pin" style="display: none; position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 350px; opacity: 0; transition: opacity 0.3s;">
                <div style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
                    <p id="pin-hint" style="text-align: center; margin: 0 0 15px 0; color: #333; font-size: 14px;">请输入密码</p>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;">
                        <div class="pin-dot"></div>
                        <div class="pin-dot"></div>
                        <div class="pin-dot"></div>
                        <div class="pin-dot"></div>
                        <div class="pin-dot"></div>
                        <div class="pin-dot"></div>
                        <div class="pin-dot"></div>
                        <div class="pin-dot"></div>
                    </div>
                    <input type="password" id="pin-password-input" placeholder="输入数字密码" 
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 18px; text-align: center; box-sizing: border-box;" 
                        maxlength="8" pattern="[0-9]*" inputmode="numeric">
                </div>
            </div>
            
            <!-- 手势密码解锁 -->
            <div id="unlock-gesture" style="display: none; position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; max-width: 95%; width: auto;">
                <div style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
                    <p id="gesture-hint" style="text-align: center; margin: 0 0 15px 0; color: #333; font-size: 14px;">请绘制手势密码</p>
                    <canvas id="unlock-gesture-canvas" width="280" height="280" 
                        style="display: block; border-radius: 12px; touch-action: none; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>
        
        <div id="home-screen" class="screen active"></div>
        
    <!-- 弹窗通知栏 -->
    <div id="notification-bar">
        <img id="notification-avatar" src="" alt="">
        <div id="notification-content">
            <div class="name"></div>
            <div class="message"></div>
        </div>
    </div>
    
    <!-- PWA安装提示 -->
    <div id="pwa-install-prompt" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 360px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 10001; animation: slideUpBounce 0.5s ease;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="https://i.postimg.cc/mZ6N4GtT/mmexport1762250594890.jpg" style="width: 50px; height: 50px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" alt="App Icon">
            <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">安装章鱼喷墨机</div>
                <div style="font-size: 13px; opacity: 0.9;">添加到主屏幕，获得完整体验</div>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 12px;">
            <button id="pwa-install-btn" style="flex: 1; background: white; color: #667eea; border: none; padding: 10px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer;">立即安装</button>
            <button id="pwa-dismiss-btn" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px; border-radius: 10px; font-size: 14px; cursor: pointer;">稍后</button>
        </div>
    </div>
    
    <div id="chat-list-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">聊天</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="create-group-btn">群聊</button>
                <button class="action-btn" id="add-chat-btn">+</button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>还没有聊天对象哦~</p>
                <p>点击右上角的“+”创建一个吧！</p>
            </div>
        </main>
    </div>
    <div id="chat-room-screen" class="screen">
        <header class="app-header" id="chat-room-header-default">
            <button class="back-btn" data-target="chat-list-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="chat-room-title">...</h1>
                <div class="subtitle" id="chat-room-subtitle">
                    <div class="online-indicator"></div>
                    <span id="chat-room-status-text">在线</span>
                </div>
            </div>
            <div class="header-action-buttons" style="display: flex; gap: 10px;">
                <button class="action-btn" id="listen-together-btn" title="一起听"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="一起听"></button>
                <button class="action-btn" id="inner-thought-btn" title="心声"><img src="https://i.postimg.cc/tCHvs910/IMG-20251204-164426.png" alt="心声"></button>
                <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png" alt="设置"></button>
            </div>
        </header>
        <header class="app-header" id="chat-room-header-select" style="display: none;">
            <button class="action-btn" id="cancel-multi-select-btn">取消</button>
            <div class="title-container">
                <h1 class="title" id="multi-select-title">选择消息</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="message-area" id="message-area"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
        </main>
        <div class="chat-input-wrapper">
            <div id="sticker-bar">
                <!-- 重说按钮 - 第一个位置 -->
                <button class="sticker-bar-btn" id="regenerate-response-btn" title="重说">
                    <svg viewBox="0 0 24 24">
                        <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                    </svg>
                </button>
                <!-- 暂停按钮 - 一直显示 -->
                <button class="sticker-bar-btn" id="stop-generation-btn" title="停止生成" disabled>
                    <svg viewBox="0 0 24 24">
                        <path d="M6,6H18V18H6V6Z" fill="currentColor"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="sticker-toggle-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="photo-video-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="image-recognition-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M21.58,16.09L19.66,18L18.24,16.58L21,13.83C21.39,13.44 22,13.44 22.39,13.83L23.17,14.61C23.56,15 23.56,15.64 23.17,16.03L21.58,17.62M20.13,12.25L18.71,13.66L20.41,15.36L21.83,13.94L20.13,12.25M5.93,19H5C3.9,19 3,18.1 3,17V5C3,3.9 3.9,3 5,3H19C20.1,3 21,3.9 21,5V11.08L19,13.08V5H5V17H5.93L13.5,9.43L16.29,12.21L12.08,16.42L5.93,19Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="camera-capture-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M20,4H16.83L15,2H9L7.17,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M20,18H4V6H8.05L9.88,4H14.12L15.95,6H20V18M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15M19,8A1,1 0 0,0 18,9A1,1 0 0,0 19,10A1,1 0 0,0 20,9A1,1 0 0,0 19,8Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="voice-message-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="wallet-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="gift-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z"/>
                    </svg>
                </button>
                <!-- 时间跳跃按钮 -->
                <button class="sticker-bar-btn" id="time-skip-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path>
                    </svg>
                </button>
                <!-- 外卖代付按钮 -->
                <button class="sticker-bar-btn" id="waimai-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M18.06 23h1.66c.84 0 1.53-.65 1.63-1.47L23 5.05h-5V1h-1.97v4.05h-4.97l.3 2.34c1.71.47 3.31 1.32 4.27 2.26 1.44 1.42 2.43 2.89 2.43 5.29V23zM1 22v-1h15.03v1c0 .54-.45 1-1.03 1H2c-.55 0-1-.46-1-1zm15.03-7C16.03 7 1 7 1 15h15.03zM1 17h15v2H1z"/>
                    </svg>
                </button>
                <!-- 分享链接按钮 -->
                <button class="sticker-bar-btn" id="share-link-btn" title="分享链接">
                    <svg viewBox="0 0 24 24">
                        <path d="M3.9,12C3.9,10.29 5.29,8.9 7,8.9H11V7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H11V15.1H7C5.29,15.1 3.9,13.71 3.9,12M8,13H16V11H8V13M17,7H13V8.9H17C18.71,8.9 20.1,10.29 20.1,12C20.1,13.71 18.71,15.1 17,15.1H13V17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7Z"/>
                    </svg>
                </button>
                <!-- 共享位置按钮 -->
                <button class="sticker-bar-btn" id="share-location-btn" title="共享位置">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                </button>
                <!-- 群聊投票按钮 -->
                <button class="sticker-bar-btn" id="send-poll-btn" style="display: none;" title="发起投票">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/>
                    </svg>
                </button>
            </div>
            <div id="reply-preview-bar">
                <div class="reply-preview-content">
                    <div class="sender">回复 xxx:</div>
                    <div class="text">被引用的消息内容...</div>
                </div>
                <span id="cancel-reply-btn">×</span>
            </div>
            <!-- @成员选择器 -->
            <div id="mention-selector" style="display: none; position: absolute; bottom: 60px; left: 20px; right: 20px; max-height: 300px; background: white; border-radius: 12px; box-shadow: 0 -2px 20px rgba(0,0,0,0.15); overflow-y: auto; z-index: 100;">
                <div id="mention-list"></div>
            </div>
            
            <div class="message-input-area" id="message-input-default">
                <input type="text" id="message-input" placeholder="输入消息...">
                <button id="send-message-btn" class="icon-btn send-btn">➤</button>
                <button id="get-reply-btn" class="icon-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z"/>
                    </svg>
                </button>
            </div>

        </div>
        <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>
            <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选
            </button>
        </div>
        <div id="forward-select-bar" style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--primary-color); color: white; padding: 12px 20px; display: none; align-items: center; justify-content: space-between; z-index: 15; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
            <span id="forward-select-count">已选择 0 项</span>
            <div style="display: flex; gap: 10px;">
                <button class="btn" id="forward-confirm-btn" style="background: white; color: var(--primary-color); width: auto; padding: 8px 16px;">转发</button>
                <button class="btn btn-secondary" id="forward-cancel-btn" style="width: auto; padding: 8px 16px;">取消</button>
            </div>
        </div>
        <div id="sticker-modal">
            <div class="header"><span>我的表情</span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary btn-small" id="add-new-sticker-btn">添加新表情</button>
                    <button class="btn btn-secondary btn-small" id="sticker-category-btn">表情分类</button>
                    <button class="btn btn-secondary btn-small" id="manage-sticker-btn">管理</button>
                </div>
            </div>
            <div style="padding: 0 10px 10px 10px;">
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
                    <label style="font-size: 14px; color: #666;">当前分组:</label>
                    <select id="current-sticker-category" style="flex: 1; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                        <option value="">全部</option>
                    </select>
                </div>
            </div>
            <div class="sticker-grid" id="sticker-grid-container"></div>
        </div>
    </div>
    <div id="world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">世界书</h1>
            </div>
            <div class="action-btn-group">
                <select id="wb-group-filter" class="wb-group-filter-select">
                    <option value="">全部</option>
                </select>
                <button class="action-btn" id="add-world-book-btn">+</button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="world-book-list-container"></ul>
            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                <p>你的世界一片混沌...</p>
                <p>点击右上角的"+"创造第一个设定吧！</p>
            </div>
            <!-- 世界书管理悬浮按钮 -->
            <div class="wb-float-btn" id="wb-float-btn">
                <span>⋮</span>
            </div>
            <!-- 世界书管理菜单 -->
            <div class="wb-float-menu" id="wb-float-menu" style="display: none;">
                <button class="wb-menu-item" id="wb-group-manage-btn">
                    <span>📁</span> 分组管理
                </button>
                <button class="wb-menu-item" id="wb-import-btn">
                    <span>📥</span> 导入
                </button>
                <button class="wb-menu-item" id="wb-export-btn">
                    <span>📤</span> 导出
                </button>
                <button class="wb-menu-item wb-danger" id="wb-delete-btn">
                    <span>🗑️</span> 删除
                </button>
            </div>
        </main>
    </div>
    <div id="edit-world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="world-book-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <form id="edit-world-book-form">
                <input type="hidden" id="world-book-id">
                <div class="form-group">
                    <label for="world-book-name">条目名称</label>
                    <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                </div>
                <div class="form-group">
                    <label for="world-book-content">条目内容</label>
                    <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="world-book-group">所属分组</label>
                    <select id="world-book-group" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                        <option value="">默认分组</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="world-book-is-global" style="width: auto; margin-right: 8px;">
                        全局世界书
                    </label>
                    <small style="display: block; color: #666; margin-top: 4px;">开启后，此世界书将自动绑定到所有角色</small>
                </div>
                <div class="form-group">
                    <label>注入位置</label>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                        <label><input type="radio" name="world-book-position" value="after"> 后</label>
                    </div>
                </div>
                <!-- 精简总结区域（仅总结类型世界书显示） -->
                <div id="summary-compress-section" style="display: none; margin-top: 20px; padding: 15px; background-color: #e3f2fd; border-radius: 8px; border: 2px solid #2196F3;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px; font-weight: 600;">📝 总结精简</h4>
                    <p style="font-size: 13px; color: #666; margin-bottom: 12px; line-height: 1.5;">
                        使用AI精简当前总结内容，提取关键信息，减少Token占用。<br>
                        <strong style="color: #f57c00;">注意：</strong>精简后会替换原有总结内容，建议先备份。
                    </p>
                    <button type="button" class="btn btn-secondary" id="compress-summary-btn" style="width: 100%; background-color: #2196F3; color: white;">
                        <span class="btn-text">🗜️ 精简目前总结</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>
                </div>
                <button type="submit" class="btn btn-primary">保存条目</button>
            </form>
        </main>
    </div>
    <div id="api-settings-screen" class="screen"></div>
    <div id="wallpaper-screen" class="screen"></div>

    <!-- 外卖界面 -->
    <div id="waimai-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="chat-room-screen">‹</button>
            <div class="title-container">
                <h2 class="title">外卖</h2>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="waimai-settings-btn" style="font-size: 20px;">⚙</button>
                <button class="action-btn" id="waimai-refresh-btn" style="font-size: 20px;">↻</button>
            </div>
        </header>
        <main class="content">
            <div class="waimai-shop-list" id="waimai-shop-list">
                <div class="placeholder-text">点击右上角刷新按钮加载外卖店铺</div>
            </div>
        </main>
    </div>

    <!-- 外卖店铺详情界面 -->
    <div id="waimai-shop-detail-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="waimai-screen">‹</button>
            <div class="title-container">
                <h2 class="title" id="waimai-shop-title">店铺名称</h2>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="waimai-menu-list" id="waimai-menu-list"></div>
        </main>
        <div class="waimai-cart-bar" id="waimai-cart-bar" style="display: none;">
            <div class="waimai-cart-info">
                <div class="waimai-cart-icon" style="font-size: 18px;">
                    &#128722;
                    <span class="waimai-cart-count" id="waimai-cart-count">0</span>
                </div>
                <div class="waimai-cart-total" id="waimai-cart-total">¥0.00</div>
            </div>
            <button class="waimai-checkout-btn" id="waimai-checkout-btn">去结算</button>
        </div>
    </div>

    <!-- 外卖支付界面 -->
    <div id="waimai-payment-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="waimai-shop-detail-screen">‹</button>
            <div class="title-container">
                <h2 class="title">确认支付</h2>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="waimai-payment-content">
                <div class="waimai-payment-amount">
                    <div class="waimai-payment-amount-label">需支付</div>
                    <div class="waimai-payment-amount-value" id="waimai-payment-amount">¥0.00</div>
                </div>
                <div class="waimai-payment-timer">
                    <div>订单剩余时间</div>
                    <div class="waimai-payment-timer-value" id="waimai-payment-timer">15:00</div>
                </div>
                <div class="waimai-payment-options">
                    <button class="waimai-payment-option-btn primary" id="waimai-self-pay-btn">自己支付</button>
                    <button class="waimai-payment-option-btn" id="waimai-request-pay-btn">请求代付</button>
                </div>
            </div>
        </main>
    </div>
    <div id="font-settings-screen" class="screen"></div>
    <div id="customize-screen" class="screen"></div>
    <div id="tutorial-screen" class="screen"></div>
    <div id="toast-notification" class="toast"></div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
    <input type="file" id="camera-capture-input" accept="image/*" capture="environment" style="display:none;">
    <div id="add-char-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色</h3>
            <form id="add-char-form">
                <div class="form-group">
                    <label for="char-real-name">角色姓名</label><input type="text" id="char-real-name"
                                                                       placeholder="角色的真实姓名" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name"
                                                                                placeholder="你对Ta的称呼" required>
                </div>
                <div class="form-group">
                    <label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char"
                                                                         placeholder="你希望Ta如何称呼你" required>
                </div>
                <button type="submit" class="btn btn-primary">创建</button>
            </form>
        </div>
    </div>
    <div id="add-sticker-modal" class="modal-overlay">
        <div class="modal-window" style="max-height: 75vh; display: flex; flex-direction: column; max-width: 400px;">
            <h3 id="add-sticker-modal-title" style="margin: 0 0 15px 0; flex-shrink: 0;">添加新表情</h3>
            <form id="add-sticker-form" style="overflow-y: auto; flex: 1; padding-right: 5px;"><input type="hidden" id="sticker-edit-id">
                <div id="sticker-preview" style="margin-bottom: 12px;"><span>预览</span></div>
                <div class="form-group" style="margin-bottom: 12px;"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name"
                                                                                         placeholder="如：开心" required>
                </div>
                <div class="form-group" style="margin-bottom: 12px;"><label for="sticker-category-select">所属分类</label>
                    <select id="sticker-category-select" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                        <option value="">默认（无分类）</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 12px;"><label for="sticker-url-input">表情URL</label><input type="url"
                                                                                             id="sticker-url-input"
                                                                                             placeholder="粘贴图片URL">
                </div>
                <p style="text-align:center; color:#888; margin: 0 0 10px;">或</p><input type="file"
                                                                                             id="sticker-file-upload"
                                                                                             accept="image/*"
                                                                                             style="display:none;"><label
                        for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 10px;">从本地上传</label>
                <button type="button" class="btn btn-secondary" id="batch-import-sticker-btn" style="width:100%; margin-bottom: 10px;">批量导入图片</button>
                <button type="button" class="btn btn-secondary" id="online-search-sticker-btn" style="width:100%; margin-bottom: 15px;">在线搜索表情</button>
                <button type="submit" class="btn btn-primary" style="width: 100%;">保存</button>
            </form>
        </div>
    </div>
    
    <!-- Batch Import Sticker Selection Modal -->
    <div id="batch-import-selection-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 360px;">
            <h3>选择批量导入方式</h3>
            <button class="btn btn-primary" id="batch-import-url-btn" style="width:100%; margin-bottom: 10px;">通过URL批量导入</button>
            <button class="btn btn-primary" id="batch-import-local-btn" style="width:100%; margin-bottom: 10px;">本地上传批量导入</button>
            <button class="btn btn-neutral" id="cancel-batch-import-selection-btn" style="width:100%;">取消</button>
        </div>
    </div>
    
    <!-- Batch Import URL Modal -->
    <div id="batch-import-url-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 500px;">
            <h3>通过URL批量导入表情</h3>
            <div class="form-group">
                <label for="batch-sticker-names">表情名称（用逗号隔开）</label>
                <input type="text" id="batch-sticker-names" placeholder="例如：开心,难过,惊讶" required>
                <small style="color: #888; display: block; margin-top: 5px;">提示：请按顺序输入表情名称，与下方URL对应</small>
            </div>
            <div class="form-group">
                <label for="batch-sticker-urls">图片URL（每行一个）</label>
                <textarea id="batch-sticker-urls" rows="8" placeholder="每行粘贴一个图片URL" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"></textarea>
                <small style="color: #888; display: block; margin-top: 5px;">提示：URL数量应与表情名称数量一致</small>
            </div>
            <div class="form-group">
                <label for="batch-sticker-category-select">所属分类</label>
                <select id="batch-sticker-category-select" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                    <option value="">默认（无分类）</option>
                </select>
            </div>
            <button class="btn btn-primary" id="confirm-batch-url-import-btn" style="width:100%; margin-bottom: 10px;">确认导入</button>
            <button class="btn btn-neutral" id="cancel-batch-url-import-btn" style="width:100%;">取消</button>
        </div>
    </div>
    
    <!-- Batch Import Local Modal -->
    <div id="batch-import-local-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 500px;">
            <h3>本地上传批量导入表情</h3>
            <div class="form-group">
                <label for="batch-sticker-names-local">表情名称（用逗号隔开）</label>
                <input type="text" id="batch-sticker-names-local" placeholder="例如：开心,难过,惊讶" required>
                <small style="color: #888; display: block; margin-top: 5px;">提示：请按顺序输入表情名称，与选择的图片对应</small>
            </div>
            <div class="form-group">
                <label>选择图片文件</label>
                <input type="file" id="batch-sticker-files" accept="image/*" multiple style="display:none;">
                <label for="batch-sticker-files" class="btn btn-secondary" style="width:100%; margin-bottom: 10px;">选择多个图片</label>
                <div id="batch-files-info" style="color: #888; font-size: 12px; margin-top: 5px;"></div>
            </div>
            <div class="form-group">
                <label for="batch-sticker-category-select-local">所属分类</label>
                <select id="batch-sticker-category-select-local" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                    <option value="">默认（无分类）</option>
                </select>
            </div>
            <button class="btn btn-primary" id="confirm-batch-local-import-btn" style="width:100%; margin-bottom: 10px;">确认导入</button>
            <button class="btn btn-neutral" id="cancel-batch-local-import-btn" style="width:100%;">取消</button>
        </div>
    </div>
    
    <!-- Online Search Sticker Modal -->
    <div id="online-search-sticker-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 800px; max-height: 70vh; display: flex; flex-direction: column;">
            <h3 style="margin: 0 0 15px 0;">在线搜索表情</h3>
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="sticker-search-keyword">搜索关键词</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="sticker-search-keyword" placeholder="输入表情关键词..." style="width: 80%; flex: 0 0 80%;">
                    <button class="btn btn-primary" id="start-search-sticker-btn" style="width: 20%; flex: 0 0 20%;">搜索</button>
                </div>
                <small style="color: #888; display: block; margin-top: 5px;">提示：将搜索多个表情包平台</small>
            </div>
            <div id="search-status" style="margin: 0 0 10px 0; color: #888; font-size: 14px; text-align: center;"></div>
            <div style="flex: 1; overflow-y: auto; min-height: 0;">
                <div id="search-results-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding-right: 5px;">
                    <!-- 搜索结果将显示在这里 -->
                </div>
            </div>
            <button class="btn btn-neutral" id="close-search-sticker-btn" style="width:100%; margin-top: 15px;">关闭</button>
        </div>
    </div>
    
    <!-- 表情包管理弹窗 -->
    <div id="manage-sticker-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="margin: 0 0 15px 0;">管理表情包</h3>
            
            <!-- 操作栏 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-small" id="select-all-stickers-btn" style="padding: 6px 12px;">全选</button>
                    <button class="btn btn-small" id="deselect-all-stickers-btn" style="padding: 6px 12px;">取消全选</button>
                </div>
                <span id="sticker-select-count" style="color: #666; font-size: 14px;">已选择: 0</span>
            </div>
            
            <!-- 表情列表 -->
            <div id="manage-sticker-grid" style="flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; padding: 10px; border: 1px solid #eee; border-radius: 8px; min-height: 200px;"></div>
            
            <!-- 底部按钮 -->
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-danger" id="delete-selected-stickers-btn" style="flex: 1;">删除选中</button>
                <button class="btn" id="close-manage-sticker-btn" style="flex: 1;">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 表情分类管理弹窗 -->
    <div id="sticker-category-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="margin: 0 0 15px 0;">表情分类管理</h3>
            
            <!-- 新建分类区域 -->
            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="new-category-name" placeholder="输入新分类名称..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                    <button class="btn btn-primary" id="create-category-btn" style="padding: 8px 16px;">新建分类</button>
                </div>
            </div>
            
            <!-- 分类列表 -->
            <div style="flex: 1; overflow-y: auto; min-height: 200px;">
                <div id="category-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- 分类项将显示在这里 -->
                </div>
            </div>
            
            <!-- 底部按钮 -->
            <div style="margin-top: 15px;">
                <button class="btn" id="close-category-modal-btn" style="width: 100%;">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 分类详情查看弹窗 -->
    <div id="category-detail-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="margin: 0 0 15px 0;" id="category-detail-title">分类详情</h3>
            
            <!-- 表情网格 -->
            <div style="flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; padding: 10px; border: 1px solid #eee; border-radius: 8px; min-height: 200px;" id="category-detail-grid"></div>
            
            <!-- 底部按钮 -->
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-danger" id="delete-category-btn" style="flex: 1;">删除分类</button>
                <button class="btn" id="close-category-detail-btn" style="flex: 1;">返回</button>
            </div>
        </div>
    </div>
    
    <div id="sticker-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
            <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>
        </div>
    </div>
    <!-- NovelAI 设置弹窗 -->
    <div id="novelai-settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-window" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <h3 style="display: flex; justify-content: space-between; align-items: center;">
                <span>NovelAI 生成设置</span>
                <button id="close-novelai-settings" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </h3>
            
            <div class="form-group">
                <label>图像尺寸（oplus可无限出小图）</label>
                <select id="nai-resolution" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <optgroup label="小">
                        <option value="512x768">纵向 (512x768)</option>
                        <option value="768x512">横向 (768x512)</option>
                        <option value="640x640">正方形 (640x640)</option>
                    </optgroup>
                    <optgroup label="正常">
                        <option value="832x1216">竖图 (832x1216)</option>
                        <option value="1216x832">横图 (1216x832)</option>
                        <option value="1024x1024" selected>方图 (1024x1024)</option>
                    </optgroup>
                    <optgroup label="壁纸">
                        <option value="1088x1920">纵向 (1088x1920)</option>
                        <option value="1920x1088">风景 (1920x1088)</option>
                    </optgroup>
                </select>
                <small style="color: #888; font-size: 12px;">建议使用官方支持的标准尺寸以获得最佳效果</small>
            </div>

            <div class="form-group">
                <label>采样步数 (Steps)</label>
                <input type="number" id="nai-steps" value="28" min="1" max="50" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <small style="color: #888; font-size: 12px;">推荐值: 28 (值越高质量越好但耗时越长)</small>
            </div>

            <div class="form-group">
                <label>提示词相关性 (CFG Scale)</label>
                <input type="number" id="nai-cfg-scale" value="5" min="1" max="20" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <small style="color: #888; font-size: 12px;">推荐值: 5 (控制图像与提示词的相关程度)</small>
            </div>

            <div class="form-group">
                <label>采样器 (Sampler)</label>
                <select id="nai-sampler" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="k_euler">Euler</option>
                    <option value="k_euler_ancestral" selected>Euler Ancestral</option>
                    <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                    <option value="k_dpmpp_2m">DPM++ 2M</option>
                    <option value="k_dpmpp_sde">DPM++ SDE</option>
                    <option value="ddim">DDIM</option>
                </select>
            </div>

            <div class="form-group">
                <label>随机种子 (Seed)</label>
                <input type="number" id="nai-seed" value="-1" min="-1" max="9999999999" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <small style="color: #888; font-size: 12px;">-1 表示随机，固定种子可复现相同图像</small>
            </div>

            <div class="form-group">
                <label>负面提示词预设 (UC Preset)</label>
                <select id="nai-uc-preset" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="0">Preset 0 - Heavy</option>
                    <option value="1" selected>Preset 1 - Light</option>
                    <option value="2">Preset 2 - Human Focus</option>
                    <option value="3">Preset 3 - None</option>
                </select>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="nai-quality-toggle" checked style="width: auto;">
                    <span>自动添加质量提升标签</span>
                </label>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="nai-smea" checked style="width: auto;">
                    <span>启用SMEA增强（提升细节）</span>
                </label>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="nai-smea-dyn" style="width: auto;">
                    <span>启用动态SMEA</span>
                </label>
            </div>

            <div class="form-group">
                <label>默认正面提示词</label>
                <textarea id="nai-default-positive" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;" placeholder="masterpiece, best quality, 1girl, beautiful...">masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style</textarea>
                <small style="color: #888; font-size: 12px;">此提示词将在生成时自动使用（如果测试弹窗中未填写）</small>
            </div>

            <div class="form-group">
                <label>默认负面提示词</label>
                <textarea id="nai-default-negative" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;" placeholder="lowres, bad anatomy, bad hands, text, error...">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea>
            </div>

            <button class="btn btn-primary" id="save-nai-settings-btn" style="width: 100%; margin-top: 15px;">保存设置</button>
        </div>
    </div>

    <!-- NovelAI 测试生成弹窗 -->
    <div id="novelai-test-modal" class="modal-overlay" style="display: none;">
        <div class="modal-window" style="max-width: 500px;">
            <h3 style="display: flex; justify-content: space-between; align-items: center;">
                <span>NovelAI 测试生成</span>
                <button id="close-novelai-test" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </h3>
            
            <div class="form-group">
                <label>正面提示词 (Prompt)</label>
                <textarea id="nai-test-prompt" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;" placeholder="1girl, beautiful, detailed face..."></textarea>
            </div>

            <div class="form-group">
                <label>负面提示词 (Negative Prompt)</label>
                <textarea id="nai-test-negative" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;" placeholder="lowres, bad anatomy..."></textarea>
            </div>

            <button class="btn btn-primary" id="nai-generate-btn" style="width: 100%;">生成图片</button>

            <div id="nai-test-result" style="margin-top: 15px; text-align: center; display: none;">
                <img id="nai-test-image" style="max-width: 100%; border-radius: 8px; cursor: pointer;" alt="生成的图片">
                <p style="font-size: 12px; color: #888; margin-top: 10px;">💡 双击图片可下载</p>
            </div>

            <div id="nai-test-loading" style="display: none; text-align: center; padding: 20px;">
                <div class="spinner" style="margin: 0 auto 10px;"></div>
                <p>正在生成图片，请稍候...</p>
            </div>
        </div>
    </div>
    
    <div id="send-voice-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发送语音消息</h3>
            <form id="send-voice-form">
                <div class="form-group">
                    <label for="voice-text-input">输入语音文字</label>
                    <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                </div>
                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                    预计时长: <span id="voice-duration-preview">0"</span>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-pv-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分享照片/视频</h3>
            <form id="send-pv-form">
                <div class="form-group">
                    <label for="pv-text-input">输入描述</label>
                    <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-transfer-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>转账</h3>
            <form id="send-transfer-form">
                <div class="form-group">
                    <label for="transfer-amount-input">金额 (元)</label>
                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="transfer-remark-input">备注</label>
                    <input type="text" id="transfer-remark-input" placeholder="（选填）">
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-gift-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>送出礼物</h3>
            <form id="send-gift-form">
                <div class="form-group">
                    <label for="gift-description-input">礼物描述</label>
                    <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- 外卖代付模态框 -->
    <div id="send-waimai-modal" class="modal-overlay">
        <div class="modal-window">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;" id="waimai-modal-title">发起外卖代付</h3>
                <button type="button" id="enter-waimai-btn" style="background: #ff6b35; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">进入外卖</button>
            </div>
            
            <!-- 外卖类型选择 -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button type="button" id="waimai-type-request" class="waimai-type-btn active" style="flex: 1; padding: 10px; border: 2px solid var(--primary-color); background: var(--primary-color); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                    请求代付
                </button>
                <button type="button" id="waimai-type-order" class="waimai-type-btn" style="flex: 1; padding: 10px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                    为<span id="waimai-char-name">TA</span>点单
                </button>
            </div>
            
            <form id="send-waimai-form">
                <div class="form-group">
                    <label for="waimai-product-input">商品信息</label>
                    <input type="text" id="waimai-product-input" placeholder="例如：一杯奶茶" required>
                </div>
                <div class="form-group">
                    <label for="waimai-amount-input">金额（元）</label>
                    <input type="number" id="waimai-amount-input" placeholder="18" step="0.01" min="0.01" required>
                </div>
                <button type="submit" class="btn btn-primary" id="waimai-submit-btn">发送</button>
            </form>
        </div>
    </div>

    <!-- 分享链接模态框 -->
    <div id="share-link-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分享链接</h3>
            <form id="share-link-form">
                <div class="form-group">
                    <label for="link-title-input">标题</label>
                    <input type="text" id="link-title-input" placeholder="输入文章或链接的标题" required>
                </div>
                <div class="form-group">
                    <label for="link-description-input">摘要 (可选)</label>
                    <textarea id="link-description-input" rows="2" placeholder="简单描述一下链接内容"></textarea>
                </div>
                <div class="form-group">
                    <label for="link-source-input">来源名称 (可选)</label>
                    <input type="text" id="link-source-input" placeholder="例如：知乎日报、B站">
                </div>
                <div class="form-group">
                    <label for="link-content-input">完整内容 (可选)</label>
                    <textarea id="link-content-input" rows="4" placeholder="粘贴或输入完整的文章内容"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-share-link-btn">取消</button>
                    <button type="submit" class="btn-primary">分享</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 共享位置模态框 -->
    <div id="share-location-modal" class="modal-overlay">
        <div class="modal-window">
            <h3> 共享位置</h3>
            <form id="share-location-form">
                <div class="form-group">
                    <label for="location-name-input">你现在在哪里呀？</label>
                    <input type="text" id="location-name-input" placeholder="例如：星巴克、学校图书馆、家里..." required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-location-btn">取消</button>
                    <button type="submit" class="btn-primary">发送位置</button>
                </div>
            </form>
        </div>
    </div>

    <!-- API选择弹窗 -->
    <div id="api-select-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择API</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">请选择要使用的API接口</p>
            <div class="api-select-buttons">
                <button class="api-primary-btn" id="use-primary-api-btn">主API</button>
                <button class="api-secondary-btn" id="use-secondary-api-btn">副API</button>
            </div>
        </div>
    </div>

    <!-- 外卖设置弹窗 -->
    <div id="waimai-settings-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>外卖设置</h3>
            <form id="waimai-settings-form">
                <div class="form-group">
                    <label for="shop-count-input">一次性刷新店铺数量</label>
                    <input type="number" id="shop-count-input" min="1" max="20" placeholder="请输入店铺数量" required>
                </div>
                <div class="form-group">
                    <label for="dish-min-input">每个店铺最少菜品数</label>
                    <input type="number" id="dish-min-input" min="1" max="50" placeholder="请输入最少菜品数" required>
                </div>
                <div class="form-group">
                    <label for="dish-max-input">每个店铺最多菜品数</label>
                    <input type="number" id="dish-max-input" min="1" max="50" placeholder="请输入最多菜品数" required>
                </div>
                <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                    <label for="save-shops-toggle" style="margin: 0;">是否保存店铺数据</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="save-shops-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-waimai-settings-btn">取消</button>
                    <button type="submit" class="btn-primary">确定</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 外卖刷新模式选择弹窗 -->
    <div id="waimai-refresh-mode-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择刷新模式</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">请选择刷新方式</p>
            <div class="refresh-mode-buttons">
                <button class="refresh-mode-btn" id="override-refresh-btn">
                    <span class="mode-icon">🔄</span>
                    <span class="mode-title">覆盖刷新</span>
                    <span class="mode-desc">清空现有店铺，重新生成</span>
                </button>
                <button class="refresh-mode-btn" id="incremental-refresh-btn">
                    <span class="mode-icon">➕</span>
                    <span class="mode-title">增量刷新</span>
                    <span class="mode-desc">保留现有店铺，新增更多</span>
                </button>
            </div>
        </div>
    </div>
    <!-- NEW: Time Skip Modal -->
    <div id="time-skip-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>记录今天发生的事</h3>
            <form id="time-skip-form">
                <div class="form-group">
                    <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>
                    <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- Status Edit Modal -->
    <div id="edit-status-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 360px;">
            <h3>修改状态</h3>
            <form id="edit-status-form">
                <div class="form-group">
                    <label for="status-input">当前状态</label>
                    <input type="text" id="status-input" placeholder="例如：在线、忙碌中、勿扰等" required style="white-space: normal; overflow: visible;">
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <!-- Edit Message Modal -->
    <div id="edit-message-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 400px;">
            <h3>编辑消息</h3>
            <form id="edit-message-form">
                <div class="form-group">
                    <label for="edit-message-textarea">消息内容</label>
                    <textarea id="edit-message-textarea" rows="4" style="resize: vertical; min-height: 80px;" required></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
                    <button type="button" class="btn btn-secondary" id="cancel-edit-message-btn" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Token Details Modal -->
    <div id="token-details-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 90%; width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
            <h3 style="margin: 0 0 15px 0;">提示词Token分析</h3>
            
            <!-- 总览统计 -->
            <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">总Token数</div>
                    <div id="token-detail-total" style="font-size: 36px; font-weight: bold; color: #333;">0</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 13px;">
                    <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #ddd;">
                        <div style="color: #666; margin-bottom: 5px;">系统提示词</div>
                        <div id="token-detail-chinese" style="font-size: 20px; font-weight: bold; color: #333;">0</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #ddd;">
                        <div style="color: #666; margin-bottom: 5px;">历史消息</div>
                        <div id="token-detail-english" style="font-size: 20px; font-weight: bold; color: #333;">0</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #ddd;">
                        <div style="color: #666; margin-bottom: 5px;">提示词模块</div>
                        <div id="token-detail-numbers" style="font-size: 20px; font-weight: bold; color: #333;">0</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #ddd;">
                        <div style="color: #666; margin-bottom: 5px;">消息条数</div>
                        <div id="token-detail-symbols" style="font-size: 20px; font-weight: bold; color: #333;">0</div>
                    </div>
                </div>
            </div>
            
            <!-- 详细列表 -->
            <div style="flex: 1; overflow-y: auto; background: #fafafa; border-radius: 8px; padding: 15px; border: 1px solid #ddd;">
                <div style="font-size: 14px; font-weight: 600; color: #666; margin-bottom: 10px;">
                    Token详细分布 (<span id="token-detail-message-count">0</span>)
                </div>
                <div id="token-detail-messages" style="display: flex; flex-direction: column;">
                    <!-- 详细列表将动态填充 -->
                </div>
            </div>
            
            <button type="button" class="btn btn-secondary" id="close-token-details-btn" style="margin-top: 15px;">关闭</button>
        </div>
    </div>
    <!-- Inner Thought Modal -->
    <div id="inner-thought-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; flex-shrink: 0;">
                <h3 style="margin: 0;">心声记录</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="inner-thought-select-all-btn" style="padding: 6px 12px; font-size: 13px; display: none;">全选</button>
                    <button class="btn btn-secondary" id="inner-thought-history-btn" style="padding: 6px 12px; font-size: 13px;">历史</button>
                    <button class="btn btn-secondary" id="inner-thought-edit-btn" style="padding: 6px 12px; font-size: 13px;">编辑</button>
                    <button class="btn btn-secondary" id="inner-thought-delete-mode-btn" style="padding: 6px 12px; font-size: 13px; display: none;">删除</button>
                </div>
            </div>
            <div id="inner-thought-list" style="flex: 1; overflow-y: auto; padding-right: 5px;">
                <!-- 心声列表将动态填充 -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-shrink: 0;">
                <button class="btn btn-primary" id="save-inner-thought-btn" style="display: none; flex: 1;">保存修改</button>
                <button class="btn btn-secondary" id="cancel-inner-thought-edit-btn" style="display: none; flex: 1;">取消</button>
                <button class="btn btn-primary" id="confirm-delete-inner-thought-btn" style="display: none; flex: 1; background: #ff4444;">确认删除</button>
                <button class="btn btn-secondary" id="cancel-delete-inner-thought-btn" style="display: none; flex: 1;">取消</button>
                <button class="btn btn-secondary" id="close-inner-thought-btn" style="flex: 1;">关闭</button>
            </div>
        </div>
    </div>
    <!-- Chat Search Modal -->
    <div id="chat-search-modal" class="modal-overlay" style="display: none;">
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f5f5f5; display: flex; flex-direction: column; max-width: 420px; margin: 0 auto;">
            <!-- Header -->
            <div style="background: white; padding: 12px 15px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0;">
                <button id="close-search-modal-btn" style="background: none; border: none; font-size: 24px; color: var(--primary-color); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">←</button>
                <div style="flex: 1; position: relative;">
                    <input type="text" id="search-keyword-input" placeholder="搜索聊天记录..." style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none;">
                    <button id="clear-search-keyword-btn" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; cursor: pointer; font-size: 16px; display: none;">✕</button>
                </div>
            </div>
            
            <!-- Search Filters -->
            <div id="search-filters" style="background: white; padding: 10px 15px; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; border-bottom: 1px solid #eee;">
                <div style="display: flex; gap: 8px; overflow-x: auto;">
                    <select id="search-filter-sender" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; outline: none; flex: 1; min-width: 120px;">
                        <option value="all">全部发送人</option>
                        <option value="user">我</option>
                    </select>
                    
                    <select id="search-filter-type" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; outline: none; flex: 1; min-width: 100px;">
                        <option value="all">全部类型</option>
                        <option value="text">文本消息</option>
                        <option value="image">图片</option>
                        <option value="voice">语音</option>
                        <option value="sticker">表情包</option>
                        <option value="transfer">转账</option>
                        <option value="gift">礼物</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="font-size: 12px; color: #666; white-space: nowrap;">日期范围:</span>
                    <input type="date" id="search-filter-date-start" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; flex: 1;">
                    <span style="font-size: 12px; color: #999;">至</span>
                    <input type="date" id="search-filter-date-end" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; flex: 1;">
                    <button id="clear-date-filter-btn" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; background: white; cursor: pointer; white-space: nowrap;">清除</button>
                </div>
            </div>
            
            <!-- Search Info Bar -->
            <div id="search-info-bar" style="background: #fff3cd; padding: 8px 15px; font-size: 12px; color: #856404; display: none; flex-shrink: 0;">
                <span id="search-info-text"></span>
            </div>
            
            <!-- Results -->
            <div id="search-results-container" style="flex: 1; overflow-y: auto; padding: 10px;">
                <div id="search-empty-state" style="text-align: center; padding: 60px 20px; color: #999;">
                    <div style="font-size: 14px;">输入关键词搜索聊天记录</div>
                </div>
                <div id="search-results-list" style="display: none;">
                    <!-- Results will be dynamically added here -->
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="search-loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 15px 25px; border-radius: 10px; font-size: 14px;">
                搜索中...
            </div>
        </div>
    </div>
    <!-- NEW: Group Recipient Selection Modal -->
    <div id="group-recipient-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="group-recipient-selection-title">选择收件人</h3>
            <ul id="group-recipient-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
            <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
            <button class="action-sheet-button" id="view-transfer-remark-btn">查看备注</button>
        </div>
    </div>
    <!-- Private Chat Settings -->
    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">聊天设置</div>
        <div class="content">
            <form id="chat-settings-form">
                <div class="avatar-setting"><img src="" alt="角色头像" id="setting-char-avatar-preview"
                                                 class="avatar-preview"><input type="file"
                                                                               id="setting-char-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-char-avatar-upload" class="btn btn-primary"
                        style="flex-grow:1;">更换角色头像</label></div>
                
                <!-- 角色头像库按钮 -->
                <div class="form-group">
                    <button type="button" id="open-avatar-library-btn" class="btn btn-secondary">
                        角色头像库
                    </button>
                </div>
                
                <!-- 角色头像框按钮 -->
                <div class="form-group">
                    <button type="button" class="btn btn-secondary change-frame-btn" data-type="char">
                        更换头像框
                    </button>
                </div>
                
                <!-- 角色头像形状选择 -->
                <div class="form-group">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">角色头像形状</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="avatar-shape-preset-btn" data-type="char" data-shape="circle" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); margin: 0 auto 5px;"></div>
                            <div style="font-size: 12px;">圆形</div>
                        </button>
                        <button type="button" class="avatar-shape-preset-btn" data-type="char" data-shape="square" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: var(--primary-color); margin: 0 auto 5px;"></div>
                            <div style="font-size: 12px;">方形</div>
                        </button>
                    </div>
                    <div style="margin-top: 10px;">
                        <label for="char-custom-shape-input" style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">自定义形状代码（CSS clip-path）</label>
                        <input type="text" id="char-custom-shape-input" placeholder="例如: circle(50%)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; margin-bottom: 8px;">
                        <button type="button" class="btn btn-secondary" id="apply-char-custom-shape-btn" style="width: 100%; padding: 8px; font-size: 13px;">应用自定义形状</button>
                    </div>
                </div>
                
                <div class="form-group"><label for="setting-char-realname">角色真名</label><input type="text"
                                                                                                    id="setting-char-realname"
                                                                                                    placeholder="角色的真实姓名">
                </div>
                <div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text"
                                                                                                       id="setting-char-remark"
                                                                                                       placeholder="你对Ta的称呼">
                </div>
                <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea
                        id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>
                
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                
                <div class="form-group">
                    <label style="font-weight: bold; font-size: 15px; color: var(--primary-color); margin-bottom: 10px; display: block;">角色NPC库</label>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px; line-height: 1.6;">
                        为该角色配置专属的NPC角色库，这些NPC可以在对话中被提及或互动。
                    </p>
                    <button type="button" class="btn btn-primary" id="manage-char-npc-library-btn" style="width: 100%;">管理NPC库</button>
                </div>
                
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <label for="setting-char-background-activity" style="margin-bottom: 0;">
                        启用后台活动
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            开启后，该角色可以在后台主动发送消息
                        </p>
                    </label>
                    <input type="checkbox" id="setting-char-background-activity" style="width: auto; height: 20px;">
                </div>
                
                <div id="char-background-activity-settings" style="display: none; margin-left: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; margin-top: 10px;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="setting-char-bg-check-interval" style="font-size: 14px; font-weight: 600; margin-bottom: 5px; display: block;">
                            后台活动检测间隔（秒）
                        </label>
                        <input type="number" id="setting-char-bg-check-interval" min="10" step="10" placeholder="留空使用全局设置" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">留空则使用API设置中的全局值</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="setting-char-bg-trigger-chance" style="font-size: 14px; font-weight: 600; margin-bottom: 5px; display: block;">
                            角色唤醒概率（%）
                        </label>
                        <input type="number" id="setting-char-bg-trigger-chance" min="0" max="100" step="1" placeholder="留空使用全局设置" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">留空则使用API设置中的全局值</small>
                    </div>
                </div>
                
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <label for="setting-char-auto-group" style="margin-bottom: 0;">
                        CHAR主动拉群开关
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            开启后，CHAR可能会主动从NPC库拉取角色创建群聊
                        </p>
                    </label>
                    <input type="checkbox" id="setting-char-auto-group" style="width: auto; height: 20px;">
                </div>
                
                <div id="char-auto-group-settings" style="display: none; margin-left: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; margin-top: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="setting-char-auto-group-interval" style="font-size: 14px; font-weight: 600; margin-bottom: 5px; display: block;">
                            主动拉群检测间隔（秒）
                        </label>
                        <input type="number" id="setting-char-auto-group-interval" min="10" step="10" placeholder="留空使用后台活动间隔" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">留空则使用后台活动的检测间隔</small>
                    </div>
                </div>
                
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <label for="setting-char-block-cooldown" style="margin-bottom: 0;">
                        拉黑冷静期（小时）
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            被拉黑后多久可以申请好友（留空使用全局设置）
                        </p>
                    </label>
                    <input type="number" id="setting-char-block-cooldown" min="0.1" step="0.1" placeholder="留空使用全局设置" style="width: 80px; text-align: center;">
                </div>
                
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting"><img src="" alt="我的头像" id="setting-my-avatar-preview"
                                                 class="avatar-preview"><input type="file" id="setting-my-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-my-avatar-upload" class="btn btn-secondary"
                        style="flex-grow:1;">更换我的头像</label></div>
                
                <!-- 我的头像库按钮 -->
                <div class="form-group">
                    <button type="button" id="open-my-avatar-library-btn" class="btn btn-secondary">
                        我的头像库
                    </button>
                </div>
                
                <!-- 我的头像框按钮 -->
                <div class="form-group">
                    <button type="button" class="btn btn-secondary change-frame-btn" data-type="my">
                        更换头像框
                    </button>
                </div>
                
                <!-- 我的头像形状选择 -->
                <div class="form-group">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">我的头像形状</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="avatar-shape-preset-btn" data-type="my" data-shape="circle" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--secondary-color); margin: 0 auto 5px;"></div>
                            <div style="font-size: 12px;">圆形</div>
                        </button>
                        <button type="button" class="avatar-shape-preset-btn" data-type="my" data-shape="square" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer;">
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: var(--secondary-color); margin: 0 auto 5px;"></div>
                            <div style="font-size: 12px;">方形</div>
                        </button>
                    </div>
                    <div style="margin-top: 10px;">
                        <label for="my-custom-shape-input" style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">自定义形状代码（CSS clip-path）</label>
                        <input type="text" id="my-custom-shape-input" placeholder="例如: circle(50%)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; margin-bottom: 8px;">
                        <button type="button" class="btn btn-secondary" id="apply-my-custom-shape-btn" style="width: 100%; padding: 8px; font-size: 13px;">应用自定义形状</button>
                    </div>
                </div>
                
                <div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text"
                                                                                            id="setting-my-name"></div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-primary" id="manage-persona-presets-btn" style="width: 100%; margin-bottom: 10px;">人设预设</button>
                </div>
                
                <div class="form-group"><label for="setting-my-persona">我的人设</label><textarea
                        id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。"></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                </div>
                
                <!-- 识别USER头像功能 -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <span>识别USER头像</span>
                        <label class="switch-container" style="margin: 0;">
                            <input type="checkbox" id="recognize-user-avatar-toggle">
                            <span class="switch-slider"></span>
                        </label>
                    </label>
                    <div id="recognize-user-avatar-info" style="display: none; font-size: 12px; color: #888; padding: 8px; background-color: #f5f5f5; border-radius: 5px; margin-top: 5px;">
                        <div id="avatar-recognition-status">未识别</div>
                        <button type="button" class="btn btn-secondary" id="force-recognize-avatar-btn" style="width: 100%; padding: 6px; font-size: 12px; margin-top: 8px;">立即识别当前头像</button>
                        <button type="button" class="btn btn-danger" id="clear-avatar-memory-btn" style="width: 100%; padding: 6px; font-size: 12px; margin-top: 8px;">清除所有头像记忆</button>
                    </div>
                </div>
                
                <!-- 挂载聊天记录功能 -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <span>挂载聊天记录</span>
                        <label class="switch-container" style="margin: 0;">
                            <input type="checkbox" id="mount-chat-history-toggle">
                            <span class="switch-slider"></span>
                        </label>
                    </label>
                    <div id="mount-chat-history-container" style="display: none;">
                        <div id="mounted-chats-list" style="margin-bottom: 10px;"></div>
                        <button type="button" class="btn btn-secondary" id="add-mounted-chat-btn" style="width: 100%; padding: 10px; font-size: 14px;">+ 添加挂载聊天</button>
                    </div>
                </div>

                <!-- 实时时间感知开关 - 独立区域 -->
                <div class="form-group" style="background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: bold; font-size: 15px; color: #333;">实时时间感知</span>
                        <label class="switch-container" style="margin: 0;">
                            <input type="checkbox" id="offline-realtime-toggle" checked>
                            <span class="switch-slider"></span>
                        </label>
                    </label>
                    <p style="font-size: 13px; color: #666; margin: 0; line-height: 1.5;">开启后，CHAR能感知到精准的实时时间（年月日时分）。关闭后，CHAR将无法感知时间信息。</p>
                </div>
                
                <!-- 线下模式功能 -->
                <div class="form-group" style="background-color: #fff3e0; border: 1px solid #ffb74d; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: bold; font-size: 15px; color: #333;">线下模式</span>
                        <label class="switch-container" style="margin: 0;">
                            <input type="checkbox" id="offline-mode-toggle">
                            <span class="switch-slider"></span>
                        </label>
                    </label>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px; line-height: 1.5;">开启后，对话将切换为长文本叙事模式，包含详细的动作、心理、场景描写。</p>
                    
                    <div id="offline-mode-container" style="display: none;">
                        <!-- 挂载线下世界书 -->
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 14px; display: block; margin-bottom: 8px; color: #555; font-weight: 500;">挂载线下世界书</label>
                            <div id="offline-worldbooks-list" style="margin-bottom: 10px; max-height: 150px; overflow-y: auto;"></div>
                            <button type="button" class="btn btn-secondary" id="add-offline-worldbook-btn" style="width: 100%; padding: 8px; font-size: 14px;">+ 添加世界书</button>
                        </div>
                        
                        <!-- 输出人称选择 -->
                        <div style="margin-bottom: 15px;">
                            <label for="offline-narrative-person" style="font-size: 14px; display: block; margin-bottom: 5px; color: #555; font-weight: 500;">输出人称</label>
                            <select id="offline-narrative-person" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="third">第三人称</option>
                                <option value="first">第一人称</option>
                                <option value="second">第二人称</option>
                            </select>
                            <small style="font-size: 12px; color: #888; display: block; margin-top: 5px;">选择AI输出时使用的叙事人称</small>
                        </div>
                        
                        <!-- 每次输出字数 -->
                        <div style="margin-bottom: 10px;">
                            <label for="offline-word-count" style="font-size: 14px; display: block; margin-bottom: 5px; color: #555; font-weight: 500;">每次输出字数 <span style="color: #ff5722;">*必填</span></label>
                            <input type="number" id="offline-word-count" placeholder="请输入字数（必填）" min="100" max="5000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <small style="font-size: 12px; color: #888; display: block; margin-top: 5px;">必须填写字数才能开启线下模式，建议范围：100-5000字</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-theme-color"></select></div>
                
                <!-- Custom Theme Colors -->
                <div class="form-group" style="margin-top: 15px;">
                    <label style="margin-bottom: 10px; display: block; font-weight: bold;">自定义主题颜色</label>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div style="flex: 1;">
                            <label for="setting-custom-char-bg" style="font-size: 13px; display: block; margin-bottom: 5px;">对方背景色</label>
                            <input type="color" id="setting-custom-char-bg" style="width: 100%; height: 40px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="flex: 1;">
                            <label for="setting-custom-char-text" style="font-size: 13px; display: block; margin-bottom: 5px;">对方文字色</label>
                            <input type="color" id="setting-custom-char-text" style="width: 100%; height: 40px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px; align-items: center; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label for="setting-custom-user-bg" style="font-size: 13px; display: block; margin-bottom: 5px;">我方背景色</label>
                            <input type="color" id="setting-custom-user-bg" style="width: 100%; height: 40px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="flex: 1;">
                            <label for="setting-custom-user-text" style="font-size: 13px; display: block; margin-bottom: 5px;">我方文字色</label>
                            <input type="color" id="setting-custom-user-text" style="width: 100%; height: 40px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                    <button type="button" class="btn btn-neutral" id="apply-custom-theme-btn" style="margin-top: 10px; width: 100%;">应用自定义颜色</button>
                    <button type="button" class="btn btn-secondary" id="reset-custom-theme-btn" style="margin-top: 8px; width: 100%;">重置为默认气泡</button>
                    
                    <!-- Theme Preset Management -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <label style="font-size: 13px; display: block; margin-bottom: 8px; font-weight: 600;">自定义主题颜色预设</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <select id="theme-preset-select" style="flex: 0 0 80%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="">-- 选择预设 --</option>
                            </select>
                            <button type="button" class="btn btn-primary" id="load-theme-preset-btn" style="flex: 0 0 calc(20% - 8px); padding: 8px 5px; font-size: 14px; white-space: nowrap;">加载</button>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="btn btn-success" id="save-theme-preset-btn" style="flex: 1; padding: 8px; font-size: 14px;">保存预设</button>
                            <button type="button" class="btn btn-danger" id="delete-theme-preset-btn" style="flex: 1; padding: 8px; font-size: 14px;">删除预设</button>
                        </div>
                    </div>

                </div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                
                <!-- Minimax 语音配置 -->
                <div class="form-group" style="background-color: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-char-minimax-enabled" style="margin: 0;">
                            <span style="font-weight: bold; font-size: 15px; color: #333;">🎙️ 角色专属 Minimax TTS</span>
                            <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px;">
                                开启后，该角色将使用专属的Minimax语音配置
                            </p>
                        </label>
                        <input type="checkbox" id="setting-char-minimax-enabled" style="width: auto; height: 20px;">
                    </div>
                    
                    <div id="char-minimax-settings" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #d0e8ff;">
                        <p style="font-size: 13px; color: #666; margin-bottom: 15px; line-height: 1.5;">配置该角色专属的Minimax TTS设置，优先级高于全局设置。</p>
                        
                        <div style="margin-bottom: 12px;">
                            <label for="setting-char-minimax-group-id" style="font-size: 14px; display: block; margin-bottom: 5px; color: #555;">Minimax Group ID</label>
                            <input type="text" id="setting-char-minimax-group-id" placeholder="输入 Group ID" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <small style="font-size: 12px; color: #888; display: block; margin-top: 5px;">留空则使用全局设置</small>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label for="setting-char-minimax-api-key" style="font-size: 14px; display: block; margin-bottom: 5px; color: #555;">Minimax API Key</label>
                            <input type="password" id="setting-char-minimax-api-key" placeholder="输入 API Key" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <small style="font-size: 12px; color: #888; display: block; margin-top: 5px;">留空则使用全局设置</small>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label for="setting-char-minimax-voice-id" style="font-size: 14px; display: block; margin-bottom: 5px; color: #555;">语音 ID (Voice ID)</label>
                            <input type="text" id="setting-char-minimax-voice-id" placeholder="例如: male-qn-qingse, female-shaonv" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <small style="font-size: 12px; color: #888; display: block; margin-top: 5px;">留空则使用全局设置</small>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label for="setting-char-minimax-speech-model" style="font-size: 14px; display: block; margin-bottom: 5px; color: #555;">语音模型</label>
                            <select id="setting-char-minimax-speech-model" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="">-- 使用全局设置 --</option>
                                <option value="speech-01">speech-01</option>
                                <option value="speech-02">speech-02</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="background-color: #fff; border-radius: 5px; padding: 10px; margin-top: 10px;">
                        <details style="cursor: pointer;">
                            <summary style="font-size: 13px; color: #555; font-weight: 500;">📋 常用语音ID参考</summary>
                            <div style="margin-top: 10px; font-size: 12px; color: #666; line-height: 1.8;">
                                <strong>男声：</strong><br>
                                • male-qn-qingse (青涩青年音)<br>
                                • male-qn-jingying (精英青年音)<br>
                                • male-qn-badao (霸道青年音)<br>
                                • male-qn-daxuesheng (大学生音)<br>
                                <br>
                                <strong>女声：</strong><br>
                                • female-shaonv (少女音)<br>
                                • female-yujie (御姐音)<br>
                                • female-chengshu (成熟女性音)<br>
                                • female-tianmei (甜美女性音)<br>
                                <br>
                                <small style="color: #999;">更多语音ID请参考Minimax官方文档</small>
                            </div>
                        </details>
                    </div>
                </div>
                
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                    
                    <!-- Bubble Style Preset Management -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <label style="font-size: 13px; display: block; margin-bottom: 8px; font-weight: 600;">自定义气泡样式预设</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <select id="bubble-style-preset-select" style="flex: 0 0 80%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="">-- 选择预设 --</option>
                            </select>
                            <button type="button" class="btn btn-primary" id="load-bubble-style-preset-btn" style="flex: 0 0 calc(20% - 8px); padding: 8px 5px; font-size: 14px; white-space: nowrap;">加载</button>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="btn btn-success" id="save-bubble-style-preset-btn" style="flex: 1; padding: 8px; font-size: 14px;">保存预设</button>
                            <button type="button" class="btn btn-danger" id="delete-bubble-style-preset-btn" style="flex: 1; padding: 8px; font-size: 14px;">删除预设</button>
                        </div>
                    </div>

                </div>

                <div class="form-group">
                    <div style="background-color: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 500; color: #333;">当前对话条数：</span>
                            <span id="current-message-count" style="font-size: 18px; font-weight: bold; color: #1e90ff;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: #333;">当前Token数：</span>
                            <span id="current-token-count" style="font-size: 18px; font-weight: bold; color: #ff6b6b;">0</span>
                        </div>
                        <button id="view-token-details-btn" style="width: 100%; margin-top: 10px; padding: 8px; background-color: #90caf9; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s;">
                            查看Token详细
                        </button>
                    </div>
                    
                    <!-- Token过大提示 -->
                    <div style="background-color: #fff3e0; border: 1px solid #ffb74d; border-radius: 8px; padding: 12px; margin-top: 10px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <label style="font-weight: 500; color: #333; margin: 0;">Token过大提示</label>
                            <label class="switch" style="margin: 0;">
                                <input type="checkbox" id="token-warning-enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="token-warning-options" style="display: none; margin-top: 10px;">
                            <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">当Token数超过以下值时提示：</label>
                            <input type="number" id="token-warning-threshold" placeholder="例如：10000" min="100" step="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>
                </div>

                <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"
                                                                                                   id="setting-max-memory"
                                                                                                   value="10" min="1">
                </div>
                
                <!-- 自动总结区域 -->
                <div class="form-group" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-top: 15px; background-color: #f9f9f9;">
                    <label style="font-weight: bold; font-size: 15px; display: block; margin-bottom: 10px;">自动总结</label>
                    <div style="margin-bottom: 10px;">
                        <label class="switch">
                            <input type="checkbox" id="setting-auto-summary-enabled">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="auto-summary-options" style="display: none;">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="setting-auto-summary-count">自动总结条数</label>
                            <input type="number" id="setting-auto-summary-count" placeholder="请输入条数" style="width: 100%;">
                            <small style="color: #666; display: block; margin-top: 5px;">每隔N条消息自动触发总结（例如：设置100，则在100、200、300楼时触发）。第二次及以后会询问是否包含之前已总结的消息。</small>
                        </div>

                        <div style="border-top: 1px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
                            <button type="button" class="btn btn-primary" id="manual-summary-btn" style="width: 100%; margin-bottom: 10px;">手动总结</button>
                            
                            <!-- 总结进度显示区域 -->
                            <div id="summary-progress-info" style="background-color: #e8f5e9; border: 1px solid #4caf50; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                                <div style="font-weight: bold; font-size: 14px; color: #2e7d32; margin-bottom: 8px;">总结进度</div>
                                <div style="font-size: 13px; color: #555; line-height: 1.6;">
                                    <div style="margin-bottom: 4px;">
                                        <strong>当前消息数：</strong><span id="current-message-count">0</span> 条
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <strong>最后总结位置：</strong><span id="last-summary-position">未总结</span>
                                    </div>
                                    <div style="color: #666; font-size: 12px; margin-top: 6px;">
                                        💡 显示最近一次总结（自动或手动）的位置
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="custom-summary-prompt">自定义总结提示词</label>
                                <textarea id="custom-summary-prompt" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-size: 14px;"></textarea>
                                <button type="button" class="btn btn-secondary" id="reset-summary-prompt-btn" style="width: 100%; margin-top: 5px; padding: 6px;">重置为默认提示词</button>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <label style="font-weight: bold; display: block; margin-bottom: 8px;">自动总结记忆库</label>
                                <button type="button" class="btn btn-primary" id="open-memory-library-btn" style="width: 100%; margin-bottom: 8px;">记忆库内容</button>
                                <button type="button" class="btn btn-danger" id="manage-memory-delete-btn" style="width: 100%;">管理删除</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 记忆库功能 -->
                <div class="form-group" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-top: 15px; background-color: #f0f8ff;">
                    <label style="font-weight: bold; font-size: 15px; display: block; margin-bottom: 10px; color: var(--primary-color);">记忆库</label>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;">保存当前对话的所有内容和设置，支持大容量存储</p>
                    
                    <button type="button" class="btn btn-primary" id="save-memory-snapshot-btn" style="width: 100%; margin-bottom: 10px;">
                        保存当前记忆
                    </button>
                    
                    <div id="memory-snapshots-list" style="margin-top: 15px;">
                        <!-- 记忆快照列表将在这里动态生成 -->
                    </div>
                </div>
                
                <!-- 时间显示设置 -->
                <div class="form-group" style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background: #fafafa; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <label style="font-weight: 600; color: var(--primary-color); font-size: 16px; margin: 0;">聊天头像下显示时分秒</label>
                        <label class="switch-container" style="margin: 0;">
                            <input type="checkbox" id="show-seconds-toggle">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 13px; color: #666;">开启后，聊天消息的时间将显示时分秒（HH:MM:SS），默认只显示时分（HH:MM）</p>
                    
                    <!-- 自定义时间格式输入框（默认隐藏） -->
                    <div id="custom-time-format-section" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <label for="custom-time-format-input" style="display: block; font-weight: 500; margin-bottom: 8px; color: #333;">自定义时间格式</label>
                        <input type="text" id="custom-time-format-input" placeholder="例如：🕐 {HH}:{MM}:{SS} 或 ⏰{HH}:{MM}:{SS}⏰" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit;">
                        <div style="margin-top: 8px; padding: 10px; background: #f0f7ff; border-radius: 6px; font-size: 12px; color: #666;">
                            <div style="font-weight: 500; margin-bottom: 5px; color: #333;">📝 格式说明：</div>
                            <div style="line-height: 1.6;">
                                • <code style="background: #fff; padding: 2px 6px; border-radius: 3px; color: #e74c3c;">{HH}</code> = 小时（00-23）<br>
                                • <code style="background: #fff; padding: 2px 6px; border-radius: 3px; color: #e74c3c;">{MM}</code> = 分钟（00-59）<br>
                                • <code style="background: #fff; padding: 2px 6px; border-radius: 3px; color: #e74c3c;">{SS}</code> = 秒钟（00-59）<br>
                                • 可以在前后添加任意文字和emoji装饰 🎨
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" id="reset-time-format-btn" style="width: 100%; margin-top: 10px; padding: 8px;">重置为默认格式</button>
                    </div>
                </div>
                
                <!-- 页面动态效果设置 -->
                <div class="form-group" style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background: #fafafa;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <label style="font-weight: 600; color: var(--primary-color); font-size: 16px; margin: 0;">页面动态效果</label>
                        <label class="switch-container" style="margin: 0;">
                            <input type="checkbox" id="page-effect-master-toggle">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    
                    <!-- 详细设置区域（默认隐藏） -->
                    <div id="page-effect-details" style="display: none;">
                    
                    <!-- 预设下雪效果 -->
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <label style="font-weight: 500; margin: 0;">预设下雪效果</label>
                            <label class="switch-container" style="margin: 0;">
                                <input type="checkbox" id="snow-effect-toggle">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                        
                        <div id="snow-effect-settings" style="display: none; margin-top: 10px; padding-left: 10px; border-left: 3px solid var(--primary-color);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <label style="font-size: 13px; color: #666;">进入页面自动触发</label>
                                <label class="switch-container" style="margin: 0;">
                                    <input type="checkbox" id="snow-auto-trigger-toggle">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">循环时长（秒）</label>
                                <input type="number" id="snow-duration-input" min="1" max="3600" value="30" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">
                                    雪花下落速度（秒）
                                    <span style="font-size: 11px; color: #999; margin-left: 5px;">范围: 1-10秒</span>
                                </label>
                                <input type="number" id="snow-speed-input" min="1" max="10" step="0.5" value="3" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="font-size: 11px; color: #999; margin-top: 3px;">数值越小，雪花下落越快</div>
                            </div>
                            
                            <!-- 雪花颜色设置 -->
                            <div style="margin-top: 15px;">
                                <label style="font-size: 13px; color: #666; display: block; margin-bottom: 8px;">雪花颜色</label>
                                
                                <!-- 颜色选择器 -->
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <input type="color" id="snow-color-picker" value="#ffffff" style="width: 50px; height: 35px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                                    <input type="text" id="snow-color-input" value="#ffffff" placeholder="#ffffff" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                                </div>
                                
                                <!-- 预设颜色 -->
                                <div style="margin-top: 10px;">
                                    <label style="font-size: 12px; color: #999; display: block; margin-bottom: 6px;">预设颜色</label>
                                    <div id="snow-color-presets" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                        <div class="snow-color-preset" data-color="#ffffff" style="width: 100%; aspect-ratio: 1; background: #ffffff; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="纯白"></div>
                                        <div class="snow-color-preset" data-color="#e3f2fd" style="width: 100%; aspect-ratio: 1; background: #e3f2fd; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="冰蓝"></div>
                                        <div class="snow-color-preset" data-color="#fce4ec" style="width: 100%; aspect-ratio: 1; background: #fce4ec; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="粉雪"></div>
                                        <div class="snow-color-preset" data-color="#fff9c4" style="width: 100%; aspect-ratio: 1; background: #fff9c4; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="金黄"></div>
                                        <div class="snow-color-preset" data-color="#e8f5e9" style="width: 100%; aspect-ratio: 1; background: #e8f5e9; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="薄荷"></div>
                                        <div class="snow-color-preset" data-color="#f3e5f5" style="width: 100%; aspect-ratio: 1; background: #f3e5f5; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="淡紫"></div>
                                        <div class="snow-color-preset" data-color="#b3e5fc" style="width: 100%; aspect-ratio: 1; background: #b3e5fc; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="天蓝"></div>
                                        <div class="snow-color-preset" data-color="#ffccbc" style="width: 100%; aspect-ratio: 1; background: #ffccbc; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="桃粉"></div>
                                        <div class="snow-color-preset" data-color="#c8e6c9" style="width: 100%; aspect-ratio: 1; background: #c8e6c9; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="嫩绿"></div>
                                        <div class="snow-color-preset" data-color="#d1c4e9" style="width: 100%; aspect-ratio: 1; background: #d1c4e9; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="薰衣草"></div>
                                        <div class="snow-color-preset" data-color="#ffe0b2" style="width: 100%; aspect-ratio: 1; background: #ffe0b2; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="杏黄"></div>
                                        <div class="snow-color-preset" data-color="#f8bbd0" style="width: 100%; aspect-ratio: 1; background: #f8bbd0; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="樱花"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 自定义动态效果 -->
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px;">
                        <label style="font-weight: 500; display: block; margin-bottom: 10px;">自定义动态效果</label>
                        
                        <textarea id="custom-effect-input" placeholder="输入自定义动态效果代码..." style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px;">
                            <label style="font-size: 13px; color: #666;">进入页面自动触发</label>
                            <label class="switch-container" style="margin: 0;">
                                <input type="checkbox" id="custom-auto-trigger-toggle">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">循环时长（秒）</label>
                            <input type="number" id="custom-duration-input" min="1" max="3600" value="30" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">
                                效果速度（秒）
                                <span style="font-size: 11px; color: #999; margin-left: 5px;">范围: 1-10秒</span>
                            </label>
                            <input type="number" id="custom-speed-input" min="1" max="10" step="0.5" value="3" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="font-size: 11px; color: #999; margin-top: 3px;">可在自定义代码中使用 speed 变量</div>
                        </div>
                    </div>
                    
                    <!-- 动态预设管理 -->
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px;">
                        <label style="font-weight: 500; display: block; margin-bottom: 10px;">动态预设</label>
                        
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <select id="effect-preset-select" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">选择预设...</option>
                            </select>
                            <button type="button" id="save-effect-preset-btn" class="btn btn-secondary" style="width: auto; padding: 6px 15px;">保存</button>
                            <button type="button" id="delete-effect-preset-btn" class="btn btn-danger" style="width: auto; padding: 6px 15px;">删除</button>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button type="button" id="apply-page-effect-btn" class="btn btn-primary" style="flex: 1;">应用</button>
                        <button type="button" id="reset-page-effect-btn" class="btn btn-secondary" style="flex: 1;">重置</button>
                        <button type="button" id="preview-page-effect-btn" class="btn btn-success" style="flex: 1;">预览</button>
                    </div>
                    
                    </div><!-- 结束 page-effect-details -->
                </div>
                
                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input
                        type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-info" id="search-chat-history-btn" style="width: 100%; margin-bottom: 10px;">查找聊天记录</button>
            <button type="button" class="btn" id="block-chat-btn" style="width: 100%; margin-bottom: 10px; background-color: #ff3b30; color: white; border-color: #ff3b30;">拉黑对方</button>
            <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>
            <button type="button" class="btn btn-success" id="export-chat-history-btn" style="margin-top: 10px; width: 100%;">导出聊天记录</button>
            <input type="file" id="import-chat-history-input" accept=".json" style="display: none;">
            <button type="button" class="btn btn-primary" id="import-chat-history-btn" style="margin-top: 10px; width: 100%;">导入聊天记录</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择要关联的世界书</h3>
            <ul id="world-book-selection-list"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>

    <!-- 线下世界书选择弹窗 -->
    <div id="offline-worldbook-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择线下世界书</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">可选择多个世界书（如文风、场景描写等）</p>
            <ul id="offline-worldbook-selection-list" style="max-height: 300px; overflow-y: auto;"></ul>
            <button class="btn btn-primary" id="save-offline-worldbook-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    
    <!-- 挂载聊天选择弹窗 -->
    <div id="mount-chat-selection-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 400px;">
            <h3>选择要挂载的聊天</h3>
            <div style="max-height: 400px; overflow-y: auto; margin: 15px 0;">
                <div id="mount-chat-selection-list"></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancel-mount-chat-btn" style="flex: 1;">取消</button>
                <button class="btn btn-primary" id="confirm-mount-chat-btn" style="flex: 1;">确认</button>
            </div>
        </div>
    </div>
    
    <!-- 保存记忆快照弹窗 -->
    <div id="save-memory-snapshot-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 400px;">
            <h3>保存记忆快照</h3>
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">快照名称</label>
                <input type="text" id="memory-snapshot-name" placeholder="例如：重要对话备份" 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancel-save-snapshot-btn" style="flex: 1;">取消</button>
                <button class="btn btn-primary" id="confirm-save-snapshot-btn" style="flex: 1;">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 恢复记忆快照确认弹窗 -->
    <div id="restore-memory-snapshot-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 400px;">
            <h3>恢复记忆快照</h3>
            <p style="margin: 15px 0; color: #666;">确定要恢复此快照吗？当前的对话内容和设置将被替换。</p>
            <div id="restore-snapshot-info" style="background: #f5f5f5; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 13px;"></div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancel-restore-snapshot-btn" style="flex: 1;">取消</button>
                <button class="btn btn-primary" id="confirm-restore-snapshot-btn" style="flex: 1;">确认恢复</button>
            </div>
        </div>
    </div>
    
    <!-- 重命名记忆快照弹窗 -->
    <div id="rename-memory-snapshot-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 400px;">
            <h3>重命名记忆快照</h3>
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">新名称</label>
                <input type="text" id="rename-snapshot-name" placeholder="输入新的快照名称" 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancel-rename-snapshot-btn" style="flex: 1;">取消</button>
                <button class="btn btn-primary" id="confirm-rename-snapshot-btn" style="flex: 1;">确认</button>
            </div>
        </div>
    </div>
    <!-- World Book Export Modal -->
    <div id="wb-export-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>导出世界书</h3>
            <div class="wb-select-all-container">
                <input type="checkbox" id="wb-export-select-all">
                <label for="wb-export-select-all">全选</label>
            </div>
            <ul id="wb-export-list" style="list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto;"></ul>
            <button class="btn btn-primary" id="wb-confirm-export-btn" style="margin-top: 20px;">确认导出</button>
            <button class="btn btn-neutral" id="wb-cancel-export-btn" style="margin-top: 10px;">取消</button>
        </div>
    </div>
    <!-- World Book Delete Modal -->
    <div id="wb-delete-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>删除世界书</h3>
            <div class="wb-select-all-container">
                <input type="checkbox" id="wb-delete-select-all">
                <label for="wb-delete-select-all">全选</label>
            </div>
            <ul id="wb-delete-list" style="list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto;"></ul>
            <button class="btn btn-danger" id="wb-confirm-delete-btn" style="margin-top: 20px;">确认删除</button>
            <button class="btn btn-neutral" id="wb-cancel-delete-btn" style="margin-top: 10px;">取消</button>
        </div>
    </div>
    <!-- World Book Group Management Modal -->
    <div id="wb-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分组管理</h3>
            <div style="margin-bottom: 20px;">
                <input type="text" id="wb-new-group-name" placeholder="输入新分组名称" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: calc(100% - 100px); margin-right: 10px;">
                <button class="btn btn-primary" id="wb-add-group-btn" style="width: 80px; padding: 8px;">添加</button>
            </div>
            <ul id="wb-group-list" style="list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;"></ul>
            <button class="btn btn-neutral" id="wb-close-group-modal-btn" style="margin-top: 20px;">关闭</button>
        </div>
    </div>
    <!-- Group Chat Creation Modal -->
    <!-- 群聊创建类型选择模态框 -->
    <div id="group-type-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择群聊类型</h3>
            <button type="button" class="btn btn-primary" id="normal-group-btn" style="width: 100%; margin-bottom: 10px;">正常创建</button>
            <button type="button" class="btn btn-secondary" id="observer-group-btn" style="width: 100%; margin-bottom: 10px;">旁观者创建</button>
            <button type="button" class="btn btn-secondary" id="cancel-group-type-btn" style="width: 100%;">取消</button>
        </div>
    </div>

    <!-- 正常群聊创建模态框 -->
    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建群聊</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>选择群成员</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">群聊名称</label>
                    <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                </div>
                <button type="submit" class="btn btn-primary">创建群聊</button>
            </form>
        </div>
    </div>

    <!-- 旁观者群聊创建模态框 -->
    <div id="create-observer-group-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3>旁观者创建群聊</h3>
            <form id="create-observer-group-form">
                <div class="form-group">
                    <label>选择角色（可多选）</label>
                    <ul id="observer-member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="observer-group-name-input">群聊名称</label>
                    <input type="text" id="observer-group-name-input" placeholder="给你的群聊起个名字吧" required>
                </div>
                
                <!-- 角色互相认识开关 -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; justify-content: space-between;">
                        <span>角色之间是否互相认识</span>
                        <input type="checkbox" id="members-know-each-other-toggle" style="width: auto;">
                    </label>
                </div>
                
                <!-- 选择互相认识的角色对 -->
                <div class="form-group" id="know-each-other-selection" style="display: none;">
                    <label>选择互相认识的角色对</label>
                    <div id="know-each-other-pairs" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                
                <!-- 记忆中是否有user开关 -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; justify-content: space-between;">
                        <span>记忆中是否有USER</span>
                        <input type="checkbox" id="memory-has-user-toggle" style="width: auto;">
                    </label>
                </div>
                
                <!-- 选择记忆中有user的角色 -->
                <div class="form-group" id="memory-has-user-selection" style="display: none;">
                    <label>选择记忆中有USER的角色</label>
                    <ul id="memory-has-user-list" class="member-selection-list"></ul>
                </div>
                
                <button type="submit" class="btn btn-primary">创建旁观者群聊</button>
            </form>
        </div>
    </div>
    
    <!-- 【群投票功能】创建投票模态框 -->
    <div id="create-poll-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 360px;">
            <h3>发起投票</h3>
            <form id="create-poll-form">
                <div class="form-group">
                    <label for="poll-question-input">投票问题</label>
                    <textarea id="poll-question-input" rows="2" placeholder="例如：今晚我们看什么电影？" style="resize: vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label>投票选项 (至少2项)</label>
                    <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- 投票选项将由JS动态生成在这里 -->
                    </div>
                    <button type="button" id="add-poll-option-btn" class="btn btn-secondary" style="margin-top: 12px; width: 100%;">+ 添加选项</button>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancel-create-poll-btn" style="flex: 1;">取消</button>
                    <button type="submit" class="btn btn-primary" id="confirm-create-poll-btn" style="flex: 1;">发起投票</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Reset Icon Options Modal -->
    <div id="reset-icon-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择重置选项</h3>
            <button type="button" class="btn btn-primary" id="reset-icon-image-btn" style="margin-bottom: 10px; width: 100%;">重置图标图片</button>
            <button type="button" class="btn btn-primary" id="reset-icon-name-btn" style="margin-bottom: 10px; width: 100%;">重置图标名字</button>
            <button type="button" class="btn btn-danger" id="reset-icon-both-btn" style="margin-bottom: 10px; width: 100%;">一起重置</button>
            <button type="button" class="btn btn-neutral" id="reset-icon-cancel-btn" style="width: 100%;">取消</button>
        </div>
    </div>
    <!-- Group Chat Settings -->
    <div id="group-settings-sidebar" class="settings-sidebar">
        <div class="header">群聊设置</div>
        <div class="content">
            <form id="group-settings-form">
                <div class="group-avatar-setting">
                    <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">
                    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-avatar-upload" class="btn btn-primary"
                           style="flex-grow:1;">更换群头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-name">群名 (AI也可见)</label>
                    <input type="text" id="setting-group-name">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting">
                    <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">
                    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-my-avatar-upload" class="btn btn-secondary"
                           style="flex-grow:1;">更换我的头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-my-nickname">我的群昵称</label>
                    <input type="text" id="setting-group-my-nickname">
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-primary" id="group-manage-persona-presets-btn" style="width: 100%; margin-bottom: 10px;">人设预设</button>
                </div>
                
                <div class="form-group">
                    <label for="setting-group-my-persona">我的人设</label>
                    <textarea id="setting-group-my-persona" placeholder="描述你希望在此群聊中扮演的形象。"></textarea>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>群成员</label>
                    <div class="group-members-list" id="group-members-list-container"></div>
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <button type="button" class="btn btn-primary" id="group-management-btn" style="width: 100%;">群设置</button>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                
                <!-- 群公告区域 -->
                <div class="form-group">
                    <label style="margin-bottom: 10px;">📢 群公告</label>
                    <div id="group-announcements-list" style="margin-bottom: 10px;">
                        <!-- 公告列表将动态生成 -->
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button type="button" class="btn btn-primary" id="add-group-announcement-btn" style="flex: 1; display: none;">新增公告</button>
                        <button type="button" class="btn btn-danger" id="delete-group-announcements-btn" style="flex: 1; display: none;">删除选中</button>
                    </div>
                </div>
                
                <!-- 群聊心声开关 -->
                <div class="form-group" style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="setting-group-inner-thought-enabled" style="margin: 0;">💭 群聊心声功能</label>
                        <label class="switch">
                            <input type="checkbox" id="setting-group-inner-thought-enabled">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <small style="color: #888; font-size: 12px; display: block; margin-top: 5px;">开启后，群聊中的AI成员会生成心声；关闭则不生成心声</small>
                </div>
                
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-group-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-group-theme-color"></select></div>
                
                <!-- Custom Theme Colors for Group -->
                <div class="form-group" style="margin-top: 15px;">
                    <label style="margin-bottom: 10px; display: block; font-weight: bold;">自定义主题颜色</label>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div style="flex: 1;">
                            <label for="setting-group-custom-char-bg" style="font-size: 13px; display: block; margin-bottom: 5px;">对方背景色</label>
                            <input type="color" id="setting-group-custom-char-bg" style="width: 100%; height: 40px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="flex: 1;">
                            <label for="setting-group-custom-char-text" style="font-size: 13px; display: block; margin-bottom: 5px;">对方文字色</label>
                            <input type="color" id="setting-group-custom-char-text" style="width: 100%; height: 40px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px; align-items: center; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label for="setting-group-custom-user-bg" style="font-size: 13px; display: block; margin-bottom: 5px;">我方背景色</label>
                            <input type="color" id="setting-group-custom-user-bg" style="width: 100%; height: 40px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="flex: 1;">
                            <label for="setting-group-custom-user-text" style="font-size: 13px; display: block; margin-bottom: 5px;">我方文字色</label>
                            <input type="color" id="setting-group-custom-user-text" style="width: 100%; height: 40px; cursor: pointer; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                    <button type="button" class="btn btn-neutral" id="apply-group-custom-theme-btn" style="margin-top: 10px; width: 100%;">应用自定义颜色</button>
                    <button type="button" class="btn btn-secondary" id="reset-group-custom-theme-btn" style="margin-top: 8px; width: 100%;">重置为默认气泡</button>
                    
                    <!-- Theme Preset Management for Group -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <label style="font-size: 13px; display: block; margin-bottom: 8px; font-weight: 600;">自定义主题颜色预设</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <select id="group-theme-preset-select" style="flex: 0 0 80%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="">-- 选择预设 --</option>
                            </select>
                            <button type="button" class="btn btn-primary" id="load-group-theme-preset-btn" style="flex: 0 0 calc(20% - 8px); padding: 8px 5px; font-size: 14px; white-space: nowrap;">加载</button>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="btn btn-success" id="save-group-theme-preset-btn" style="flex: 1; padding: 8px; font-size: 14px;">保存预设</button>
                            <button type="button" class="btn btn-danger" id="delete-group-theme-preset-btn" style="flex: 1; padding: 8px; font-size: 14px;">删除预设</button>
                        </div>
                    </div>

                </div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                    </div>
                    <div id="group-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-group-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                    
                    <!-- Bubble Style Preset Management for Group -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <label style="font-size: 13px; display: block; margin-bottom: 8px; font-weight: 600;">自定义气泡样式预设</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <select id="group-bubble-style-preset-select" style="flex: 0 0 80%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="">-- 选择预设 --</option>
                            </select>
                            <button type="button" class="btn btn-primary" id="load-group-bubble-style-preset-btn" style="flex: 0 0 calc(20% - 8px); padding: 8px 5px; font-size: 14px; white-space: nowrap;">加载</button>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="btn btn-success" id="save-group-bubble-style-preset-btn" style="flex: 1; padding: 8px; font-size: 14px;">保存预设</button>
                            <button type="button" class="btn btn-danger" id="delete-group-bubble-style-preset-btn" style="flex: 1; padding: 8px; font-size: 14px;">删除预设</button>
                        </div>
                    </div>

                </div>

                <div class="form-group">
                    <div style="background-color: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 500; color: #333;">当前对话条数：</span>
                            <span id="group-current-message-count" style="font-size: 18px; font-weight: bold; color: #1e90ff;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: #333;">当前Token数：</span>
                            <span id="group-current-token-count" style="font-size: 18px; font-weight: bold; color: #ff6b6b;">0</span>
                        </div>
                        <button id="view-group-token-details-btn" style="width: 100%; margin-top: 10px; padding: 8px; background-color: #90caf9; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s;">
                            查看Token详细
                        </button>
                    </div>
                    
                    <!-- Token过大提示（群聊） -->
                    <div style="background-color: #fff3e0; border: 1px solid #ffb74d; border-radius: 8px; padding: 12px; margin-top: 10px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <label style="font-weight: 500; color: #333; margin: 0;">Token过大提示</label>
                            <label class="switch" style="margin: 0;">
                                <input type="checkbox" id="group-token-warning-enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="group-token-warning-options" style="display: none; margin-top: 10px;">
                            <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">当Token数超过以下值时提示：</label>
                            <input type="number" id="group-token-warning-threshold" placeholder="例如：10000" min="100" step="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>
                </div>

                <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number"
                                                                                                         id="setting-group-max-memory"
                                                                                                         value="10"
                                                                                                         min="1"></div>
                
                <!-- 群聊自动总结区域 -->
                <div class="form-group" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-top: 15px; background-color: #f9f9f9;">
                    <label style="font-weight: bold; font-size: 15px; display: block; margin-bottom: 10px;">自动总结</label>
                    <div style="margin-bottom: 10px;">
                        <label class="switch">
                            <input type="checkbox" id="setting-group-auto-summary-enabled">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="group-auto-summary-options" style="display: none;">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="setting-group-auto-summary-count">自动总结条数</label>
                            <input type="number" id="setting-group-auto-summary-count" placeholder="请输入条数" style="width: 100%;">
                            <small style="color: #666; display: block; margin-top: 5px;">每隔N条消息自动触发总结（例如：设置100，则在100、200、300楼时触发）。第二次及以后会询问是否包含之前已总结的消息。</small>
                        </div>

                        <div style="border-top: 1px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
                            <button type="button" class="btn btn-primary" id="group-manual-summary-btn" style="width: 100%; margin-bottom: 10px;">手动总结</button>
                            
                            <!-- 群聊总结进度显示区域 -->
                            <div id="group-summary-progress-info" style="background-color: #e8f5e9; border: 1px solid #4caf50; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                                <div style="font-weight: bold; font-size: 14px; color: #2e7d32; margin-bottom: 8px;">📊 总结进度</div>
                                <div style="font-size: 13px; color: #555; line-height: 1.6;">
                                    <div style="margin-bottom: 4px;">
                                        <strong>当前消息数：</strong><span id="group-current-message-count">0</span> 条
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <strong>最后总结位置：</strong><span id="group-last-summary-position">未总结</span>
                                    </div>
                                    <div style="color: #666; font-size: 12px; margin-top: 6px;">
                                        💡 显示最近一次总结（自动或手动）的位置
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="group-custom-summary-prompt">自定义总结提示词</label>
                                <textarea id="group-custom-summary-prompt" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-size: 14px;"></textarea>
                                <button type="button" class="btn btn-secondary" id="group-reset-summary-prompt-btn" style="width: 100%; margin-top: 5px; padding: 6px;">重置为默认提示词</button>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <label style="font-weight: bold; display: block; margin-bottom: 8px;">自动总结记忆库</label>
                                <button type="button" class="btn btn-primary" id="group-open-memory-library-btn" style="width: 100%; margin-bottom: 8px;">记忆库内容</button>
                                <button type="button" class="btn btn-danger" id="group-manage-memory-delete-btn" style="width: 100%;">管理删除</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group"><label for="setting-group-chat-bg-upload"
                                               class="btn btn-primary">更换聊天背景</label><input type="file"
                                                                                                  id="setting-group-chat-bg-upload"
                                                                                                  accept="image/*"
                                                                                                  style="display:none;">
                </div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-info" id="search-group-chat-history-btn" style="width: 100%; margin-bottom: 10px;">查找聊天记录</button>
            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>
            <button type="button" class="btn btn-success" id="export-group-chat-history-btn" style="margin-top: 10px; width: 100%;">导出聊天记录</button>
            <input type="file" id="import-group-chat-history-input" accept=".json" style="display: none;">
            <button type="button" class="btn btn-primary" id="import-group-chat-history-btn" style="margin-top: 10px; width: 100%;">导入聊天记录</button>
        </div>
    </div>
    <!-- Group Member Edit Modal -->
    <div id="edit-group-member-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 id="edit-group-member-title">编辑群成员</h3>
            <form id="edit-group-member-form">
                <input type="hidden" id="editing-member-id">
                <div class="form-group">
                    <label>成员头像</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="" alt="成员头像" id="edit-member-avatar-preview" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                        <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                        <label for="edit-member-avatar-upload" class="btn btn-secondary" style="flex: 1; margin: 0; cursor: pointer;">选择头像</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-member-group-nickname">群昵称</label>
                    <input type="text" id="edit-member-group-nickname" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-real-name">真名</label>
                    <input type="text" id="edit-member-real-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-persona">人设</label>
                    <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。" style="min-height: 120px;"></textarea>
                </div>
                
                <!-- 群成员Minimax TTS配置 -->
                <div class="form-group" style="background-color: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="edit-member-minimax-enabled" style="margin: 0;">
                            <span style="font-weight: bold; font-size: 14px; color: #333;">🎙️ 成员专属 Minimax TTS</span>
                            <p style="font-size: 11px; font-weight: normal; color: #666; margin-top: 3px;">
                                开启后，该成员将使用专属的Minimax语音配置
                            </p>
                        </label>
                        <input type="checkbox" id="edit-member-minimax-enabled" style="width: auto; height: 18px;">
                    </div>
                    
                    <div id="member-minimax-settings" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #d0e8ff;">
                        <div style="margin-bottom: 10px;">
                            <label for="edit-member-minimax-group-id" style="font-size: 13px; display: block; margin-bottom: 4px; color: #555;">Minimax Group ID</label>
                            <input type="text" id="edit-member-minimax-group-id" placeholder="输入 Group ID" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
                            <small style="font-size: 11px; color: #888; display: block; margin-top: 3px;">留空则使用全局设置</small>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label for="edit-member-minimax-api-key" style="font-size: 13px; display: block; margin-bottom: 4px; color: #555;">Minimax API Key</label>
                            <input type="password" id="edit-member-minimax-api-key" placeholder="输入 API Key" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
                            <small style="font-size: 11px; color: #888; display: block; margin-top: 3px;">留空则使用全局设置</small>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label for="edit-member-minimax-voice-id" style="font-size: 13px; display: block; margin-bottom: 4px; color: #555;">语音 ID (Voice ID)</label>
                            <input type="text" id="edit-member-minimax-voice-id" placeholder="例如: male-qn-qingse" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
                            <small style="font-size: 11px; color: #888; display: block; margin-top: 3px;">留空则使用全局设置</small>
                        </div>
                        
                        <div style="margin-bottom: 0;">
                            <label for="edit-member-minimax-speech-model" style="font-size: 13px; display: block; margin-bottom: 4px; color: #555;">语音模型</label>
                            <select id="edit-member-minimax-speech-model" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
                                <option value="">-- 使用全局设置 --</option>
                                <option value="speech-01">speech-01</option>
                                <option value="speech-02">speech-02</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    
    <!-- Kick Members Modal -->
    <div id="kick-members-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 500px; max-height: 70vh; overflow-y: auto;">
            <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">踢出群成员</h3>
            <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; font-size: 13px; color: #856404;">
                ⚠️ 权限说明：<br>
                • 群主可以踢出任何成员（包括管理员）<br>
                • 管理员只能踢出普通成员，不能踢出群主和其他管理员<br>
                • 被踢出的成员将从群聊中移除
            </div>
            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                <button type="button" class="btn btn-secondary" id="select-all-kick-members-btn" style="padding: 6px 12px; font-size: 14px;">全选</button>
                <span id="kick-selected-count" style="color: #666; font-size: 14px;">已选择 0 人</span>
            </div>
            <div id="kick-members-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                <!-- 动态生成成员列表 -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-danger" id="confirm-kick-members-btn" style="flex: 1;">确定踢出</button>
                <button type="button" class="btn btn-secondary" id="cancel-kick-members-btn" style="flex: 1;">取消</button>
            </div>
        </div>
    </div>
    
    <!-- Transfer Owner Modal -->
    <div id="transfer-owner-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 500px; max-height: 70vh; overflow-y: auto;">
            <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">转让群主</h3>
            <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; font-size: 13px; color: #856404;">
                ⚠️ 转让群主后，您将失去群主权限，新群主将获得所有管理权限
            </div>
            <div id="owner-selection-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                <!-- 动态生成成员列表 -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-primary" id="confirm-transfer-owner-btn" style="flex: 1;">确定转让</button>
                <button type="button" class="btn btn-secondary" id="cancel-transfer-owner-btn" style="flex: 1;">取消</button>
            </div>
        </div>
    </div>
    
    <!-- Set Admin Modal -->
    <div id="set-admin-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 500px; max-height: 70vh; overflow-y: auto;">
            <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">设置管理员</h3>
            <div style="margin-bottom: 15px; padding: 10px; background-color: #f0f8ff; border-radius: 8px; font-size: 13px; color: #666;">
                选择群成员设为管理员，管理员在群成员列表中会显示特殊标识
            </div>
            <div id="admin-selection-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                <!-- 动态生成成员列表 -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-primary" id="confirm-set-admin-btn" style="flex: 1;">确定</button>
                <button type="button" class="btn btn-secondary" id="cancel-set-admin-btn" style="flex: 1;">取消</button>
            </div>
        </div>
    </div>
    
    <!-- Group Management Modal -->
    <div id="group-management-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 400px;">
            <h3 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">群管理</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button type="button" class="btn btn-primary" id="set-admin-btn" style="width: 100%; padding: 12px; font-size: 15px;">
                    设置管理员
                </button>
                <button type="button" class="btn btn-primary" id="mute-management-btn" style="width: 100%; padding: 12px; font-size: 15px;">
                    群禁言管理
                </button>
                <button type="button" class="btn btn-primary" id="transfer-owner-btn" style="width: 100%; padding: 12px; font-size: 15px;">
                    转让群主
                </button>
                <button type="button" class="btn btn-primary" id="toggle-group-search-btn" style="width: 100%; padding: 12px; font-size: 15px;">
                    关闭群搜索
                </button>
                <button type="button" class="btn btn-danger" id="kick-all-members-btn" style="width: 100%; padding: 12px; font-size: 15px;">
                    一键踢出人
                </button>
                <button type="button" class="btn btn-secondary" id="close-group-management-btn" style="width: 100%; padding: 12px; font-size: 15px; margin-top: 10px;">
                    关闭
                </button>
            </div>
        </div>
    </div>
    
    <!-- Mute Management Modal -->
    <div id="mute-management-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 450px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; text-align: center; color: var(--primary-color);">群禁言管理</h3>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button type="button" class="btn btn-primary" id="mute-members-btn" style="flex: 1; padding: 10px;">
                    禁言成员
                </button>
                <button type="button" class="btn btn-secondary" id="unmute-members-btn" style="flex: 1; padding: 10px;">
                    解除禁言
                </button>
                <button type="button" class="btn btn-danger" id="mute-all-btn" style="flex: 1; padding: 10px;">
                    全员禁言
                </button>
            </div>
            
            <div id="mute-member-list" style="margin-bottom: 15px;">
                <!-- 成员列表将动态生成 -->
            </div>
            
            <div id="mute-duration-section" style="display: none; margin-bottom: 15px; padding: 15px; background: #f5f5f5; border-radius: 10px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">禁言时长</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                    <button type="button" class="mute-duration-btn" data-minutes="10">10分钟</button>
                    <button type="button" class="mute-duration-btn" data-minutes="30">30分钟</button>
                    <button type="button" class="mute-duration-btn" data-minutes="60">1小时</button>
                    <button type="button" class="mute-duration-btn" data-minutes="360">6小时</button>
                    <button type="button" class="mute-duration-btn" data-minutes="1440">1天</button>
                    <button type="button" class="mute-duration-btn" data-minutes="10080">7天</button>
                    <button type="button" class="mute-duration-btn" data-minutes="-1">永久</button>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="number" id="custom-mute-minutes" placeholder="自定义分钟数" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;" min="1">
                    <button type="button" class="btn btn-primary" id="confirm-mute-btn" style="padding: 8px 15px;">确认禁言</button>
                </div>
            </div>
            
            <button type="button" class="btn btn-secondary" id="close-mute-management-btn" style="width: 100%; padding: 12px; margin-top: 10px;">
                关闭
            </button>
        </div>
    </div>
    
    <!-- AI Generate Character Modal -->
    <div id="ai-generate-char-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">AI生成角色</h3>
            <form id="ai-generate-char-form">
                <div class="form-group">
                    <label for="ai-gen-must-have">必须有的特征</label>
                    <textarea id="ai-gen-must-have" placeholder="例如：女性、温柔、喜欢读书、长发..." style="min-height: 80px;"></textarea>
                    <small style="color: #888; font-size: 12px;">生成的角色必须包含这些特征（可选填）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-must-not-have">不希望有的特征</label>
                    <textarea id="ai-gen-must-not-have" placeholder="例如：暴力、粗鲁、冷漠..." style="min-height: 80px;"></textarea>
                    <small style="color: #888; font-size: 12px;">生成的角色绝对不能包含这些特征（可选填）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-word-count">生成字数</label>
                    <input type="number" id="ai-gen-word-count" placeholder="例如：500" min="100" max="5000" step="50">
                    <small style="color: #888; font-size: 12px;">角色人设的字数，留空则自动决定（建议300-1000字）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-template">角色模板（JSON格式）</label>
                    <textarea id="ai-gen-template" placeholder='例如：{"name": "", "age": "", "personality": "", "background": ""}' style="min-height: 100px; font-family: monospace; font-size: 13px;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <input type="file" id="ai-gen-template-file" accept=".txt,.docx" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="upload-template-btn" style="width: 50%; padding: 8px; font-size: 13px;">从文件导入模板</button>
                        <button type="button" class="btn btn-secondary" id="clear-template-btn" style="width: 50%; padding: 8px; font-size: 13px;">清空</button>
                    </div>
                    <small style="color: #888; font-size: 12px;">自定义角色卡格式，留空则使用默认格式（支持TXT、DOCX文件）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-system-prompt">AI系统词语（选填）</label>
                    <textarea id="ai-gen-system-prompt" placeholder="例如：请使用优雅的文风、注重细节描写、保持角色一致性..." style="min-height: 100px;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <input type="file" id="ai-gen-system-prompt-file" accept=".txt,.docx" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="upload-system-prompt-btn" style="width: 50%; padding: 8px; font-size: 13px;">从文件导入</button>
                        <button type="button" class="btn btn-secondary" id="clear-system-prompt-btn" style="width: 50%; padding: 8px; font-size: 13px;">清空</button>
                    </div>
                    <div style="margin-top: 8px;">
                        <label style="font-size: 13px; color: #666;">系统词位置：</label>
                        <div style="display: flex; gap: 8px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-system-position" value="before" checked style="margin-right: 5px;">
                                <span style="font-size: 13px;">前面</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-system-position" value="middle" style="margin-right: 5px;">
                                <span style="font-size: 13px;">中间</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-system-position" value="after" style="margin-right: 5px;">
                                <span style="font-size: 13px;">后面</span>
                            </label>
                        </div>
                    </div>
                    <small style="color: #888; font-size: 12px;">添加AI人格化的系统词或文风指导，可以影响生成的角色风格（支持TXT、DOCX文件）</small>
                </div>
                
                <div class="form-group">
                    <label>选择API</label>
                    <div style="display: flex; gap: 10px;">
                        <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="ai-gen-api-type" value="main" checked style="margin-right: 8px;">
                            <span>主API</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="ai-gen-api-type" value="secondary" style="margin-right: 8px;">
                            <span>副API</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-count">生成数量</label>
                    <input type="number" id="ai-gen-count" value="1" min="1" max="10" required>
                    <small style="color: #888; font-size: 12px;">一次生成几个角色（1-10个）</small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">开始生成</button>
                    <button type="button" class="btn btn-secondary" id="close-ai-generate-modal" style="flex: 1;">取消</button>
                </div>
            </form>
            
            <div id="ai-gen-result" style="margin-top: 20px; display: none;">
                <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
                <h4 style="color: var(--primary-color);">生成结果</h4>
                <div id="ai-gen-result-content" style="max-height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px; font-size: 14px; line-height: 1.6;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Generate Persona Preset Modal -->
    <div id="ai-generate-persona-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">AI生成人设预设</h3>
            <form id="ai-generate-persona-form">
                <div class="form-group">
                    <label for="ai-gen-persona-must-have">必须有的特征</label>
                    <textarea id="ai-gen-persona-must-have" placeholder="例如：温柔、善良、喜欢读书..." style="min-height: 80px;"></textarea>
                    <small style="color: #888; font-size: 12px;">生成的人设必须包含这些特征（可选填）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-persona-must-not-have">不希望有的特征</label>
                    <textarea id="ai-gen-persona-must-not-have" placeholder="例如：暴力、粗鲁、冷漠..." style="min-height: 80px;"></textarea>
                    <small style="color: #888; font-size: 12px;">生成的人设绝对不能包含这些特征（可选填）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-persona-word-count">生成字数</label>
                    <input type="number" id="ai-gen-persona-word-count" placeholder="例如：300" min="100" max="5000" step="50">
                    <small style="color: #888; font-size: 12px;">人设描述的字数，留空则自动决定（建议200-800字）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-persona-template">人设模板</label>
                    <textarea id="ai-gen-persona-template" placeholder="例如：性格、外貌、背景、爱好..." style="min-height: 80px; font-family: monospace; font-size: 13px;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <input type="file" id="ai-gen-persona-template-file" accept=".txt,.docx" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="upload-persona-template-btn" style="width: 50%; padding: 8px; font-size: 13px;">从文件导入模板</button>
                        <button type="button" class="btn btn-secondary" id="clear-persona-template-btn" style="width: 50%; padding: 8px; font-size: 13px;">清空</button>
                    </div>
                    <small style="color: #888; font-size: 12px;">自定义人设格式，留空则使用默认格式（支持TXT、DOCX文件）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-persona-system-prompt">AI系统词语（选填）</label>
                    <textarea id="ai-gen-persona-system-prompt" placeholder="例如：请使用优雅的文风、注重细节描写、保持角色一致性..." style="min-height: 100px;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <input type="file" id="ai-gen-persona-system-prompt-file" accept=".txt,.docx" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="upload-persona-system-prompt-btn" style="width: 50%; padding: 8px; font-size: 13px;">从文件导入</button>
                        <button type="button" class="btn btn-secondary" id="clear-persona-system-prompt-btn" style="width: 50%; padding: 8px; font-size: 13px;">清空</button>
                    </div>
                    <div style="margin-top: 8px;">
                        <label style="font-size: 13px; color: #666;">系统词位置：</label>
                        <div style="display: flex; gap: 8px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-persona-system-position" value="before" checked style="margin-right: 5px;">
                                <span style="font-size: 13px;">前面</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-persona-system-position" value="middle" style="margin-right: 5px;">
                                <span style="font-size: 13px;">中间</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-persona-system-position" value="after" style="margin-right: 5px;">
                                <span style="font-size: 13px;">后面</span>
                            </label>
                        </div>
                    </div>
                    <small style="color: #888; font-size: 12px;">添加AI人格化的系统词或文风指导，可以影响生成的人设风格（支持TXT、DOCX文件）</small>
                </div>
                
                <div class="form-group">
                    <label>选择API</label>
                    <div style="display: flex; gap: 10px;">
                        <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="ai-gen-persona-api-type" value="main" checked style="margin-right: 8px;">
                            <span>主API</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="ai-gen-persona-api-type" value="secondary" style="margin-right: 8px;">
                            <span>副API</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-persona-count">生成数量</label>
                    <input type="number" id="ai-gen-persona-count" value="1" min="1" max="10" required>
                    <small style="color: #888; font-size: 12px;">一次生成几个人设（1-10个）</small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">开始生成</button>
                    <button type="button" class="btn btn-secondary" id="close-ai-generate-persona-modal" style="flex: 1;">取消</button>
                </div>
            </form>
            
            <div id="ai-gen-persona-result" style="margin-top: 20px; display: none;">
                <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
                <h4 style="color: var(--primary-color);">生成结果</h4>
                <div id="ai-gen-persona-result-content" style="max-height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px; font-size: 14px; line-height: 1.6;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Avatar Library Modal -->
    <div id="avatar-library-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3 style="display: flex; justify-content: space-between; align-items: center;">
                <span>角色头像库</span>
                <button id="close-avatar-library-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </h3>
            
            <!-- Upload Section -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <input type="file" id="avatar-library-upload" accept="image/*" multiple style="display: none;">
                <label for="avatar-library-upload" class="btn btn-primary" style="width: 100%; margin-bottom: 10px; cursor: pointer;">
                    批量上传头像
                </label>
                <div style="margin-top: 10px;">
                    <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">
                        为头像命名（多个头像用英文逗号隔开）：
                    </label>
                    <input type="text" id="avatar-names-input" placeholder="例如：开心,生气,悲伤" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>
                <button id="confirm-upload-avatars-btn" class="btn btn-success" style="width: 100%; margin-top: 10px;">
                    确认上传
                </button>
            </div>
            
            <!-- Selection Controls -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <button id="select-all-avatars-btn" class="btn btn-secondary" style="flex: 1;">全选</button>
                <button id="deselect-all-avatars-btn" class="btn btn-secondary" style="flex: 1;">取消全选</button>
                <button id="delete-selected-avatars-btn" class="btn btn-danger" style="flex: 1;">删除选中</button>
            </div>
            
            <!-- Binding Management -->
            <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px;">
                <div style="font-size: 13px; color: #1976d2; margin-bottom: 8px; font-weight: 500;">💑 情头绑定管理</div>
                <button id="manage-avatar-bindings-btn" class="btn btn-primary" style="width: 100%; padding: 8px; font-size: 13px;">查看/管理情头绑定</button>
            </div>
            
            <!-- Avatar Grid -->
            <div id="avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 15px;">
                <!-- Avatars will be dynamically inserted here -->
            </div>
            
            <div id="avatar-library-empty" style="text-align: center; padding: 40px; color: #999; display: none;">
                <p style="font-size: 16px; color: #ccc; margin: 0;">暂无头像</p>
                <p style="font-size: 13px;">点击上方按钮批量上传头像</p>
            </div>
        </div>
    </div>
    
    <!-- Avatar Binding Management Modal -->
    <div id="avatar-binding-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
            <h3 style="display: flex; justify-content: space-between; align-items: center;">
                <span>💑 情头绑定管理</span>
                <button id="close-avatar-binding-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffb74d;">
                <div style="font-size: 13px; color: #e65100; line-height: 1.6;">
                    <strong>💡 使用说明：</strong><br>
                    • 点击"新建绑定"创建情头对<br>
                    • 每个头像只能绑定一个配对头像<br>
                    • CHAR可以根据情头备注为你和TA换上喜欢的情头<br>
                    • CHAR知道哪些是情头，会在合适的时候使用
                </div>
            </div>
            
            <button id="create-new-binding-btn" class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 10px;">
                ➕ 新建情头绑定
            </button>
            
            <!-- Bindings List -->
            <div id="avatar-bindings-list" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Bindings will be dynamically inserted here -->
            </div>
            
            <div id="avatar-bindings-empty" style="text-align: center; padding: 40px; color: #999; display: none;">
                <p style="font-size: 16px; color: #ccc; margin: 0;">暂无情头绑定</p>
                <p style="font-size: 13px;">点击上方按钮创建情头绑定</p>
            </div>
        </div>
    </div>
    
    <!-- Create Binding Modal -->
    <div id="create-binding-modal" class="modal-overlay" style="z-index: 10002;">
        <div class="modal-window" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <h3 style="display: flex; justify-content: space-between; align-items: center;">
                <span>创建情头绑定</span>
                <button id="close-create-binding-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </h3>
            
            <div style="margin-bottom: 20px;">
                <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px;">
                    <strong>步骤1：</strong> 选择角色头像（CHAR的头像）
                </label>
                <div id="select-char-avatar-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                    <!-- Char avatars will be inserted here -->
                </div>
                <div id="selected-char-avatar-display" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 8px; display: none;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img id="selected-char-avatar-img" src="" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                        <div>
                            <div style="font-size: 13px; color: #2e7d32; font-weight: 500;">已选择角色头像</div>
                            <div id="selected-char-avatar-name" style="font-size: 12px; color: #666;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px;">
                    <strong>步骤2：</strong> 选择我的头像（USER的头像）
                </label>
                <div id="select-my-avatar-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                    <!-- My avatars will be inserted here -->
                </div>
                <div id="selected-my-avatar-display" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 8px; display: none;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img id="selected-my-avatar-img" src="" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                        <div>
                            <div style="font-size: 13px; color: #1976d2; font-weight: 500;">已选择我的头像</div>
                            <div id="selected-my-avatar-name" style="font-size: 12px; color: #666;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px;">
                    <strong>步骤3：</strong> 为这对情头添加备注（可选）
                </label>
                <input type="text" id="binding-remark-input" placeholder="例如：甜蜜情侣、可爱风格、酷炫黑白..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                <div style="font-size: 12px; color: #999; margin-top: 5px;">备注可以帮助CHAR理解这对情头的风格，选择合适的时机使用</div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="cancel-create-binding-btn" class="btn btn-secondary" style="flex: 1;">取消</button>
                <button id="confirm-create-binding-btn" class="btn btn-primary" style="flex: 1;">确认创建</button>
            </div>
        </div>
    </div>

    <!-- My Avatar Library Modal -->
    <div id="my-avatar-library-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3 style="display: flex; justify-content: space-between; align-items: center;">
                <span>我的头像库</span>
                <button id="close-my-avatar-library-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </h3>
            
            <!-- Upload Section -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <input type="file" id="my-avatar-library-upload" accept="image/*" multiple style="display: none;">
                <label for="my-avatar-library-upload" class="btn btn-primary" style="width: 100%; margin-bottom: 10px; cursor: pointer;">
                    批量上传头像
                </label>
                <div style="margin-top: 10px;">
                    <label style="font-size: 13px; color: #666; display: block; margin-bottom: 5px;">
                        为头像命名（多个头像用英文逗号隔开）：
                    </label>
                    <input type="text" id="my-avatar-names-input" placeholder="例如：工作,休闲,运动" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>
                <button id="confirm-upload-my-avatars-btn" class="btn btn-success" style="width: 100%; margin-top: 10px;">
                    确认上传
                </button>
            </div>
            
            <!-- Selection Controls -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <button id="select-all-my-avatars-btn" class="btn btn-secondary" style="flex: 1;">全选</button>
                <button id="deselect-all-my-avatars-btn" class="btn btn-secondary" style="flex: 1;">取消全选</button>
                <button id="delete-selected-my-avatars-btn" class="btn btn-danger" style="flex: 1;">删除选中</button>
            </div>
            
            <!-- Avatar Grid -->
            <div id="my-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 15px;">
                <!-- Avatars will be dynamically inserted here -->
            </div>
            
            <div id="my-avatar-library-empty" style="text-align: center; padding: 40px; color: #999; display: none;">
                <p style="font-size: 16px; color: #ccc; margin: 0;">暂无头像</p>
                <p style="font-size: 13px;">点击上方按钮批量上传头像</p>
            </div>
        </div>
    </div>
    
    <!-- Add Member to Group Action Sheet -->
    <div id="add-member-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>
            <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>
            <button class="action-sheet-button" id="ai-generate-group-member-btn">AI生成群成员</button>
        </div>
    </div>
    <!-- Invite Existing Member Modal -->
    <div id="invite-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>邀请成员加入群聊</h3>
            <ul id="invite-member-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>
        </div>
    </div>
    <!-- Forward Message Modal -->
    <div id="forward-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择转发目标</h3>
            <div style="margin: 20px 0;">
                <input type="text" id="forward-search-input" placeholder="搜索对话..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            <div id="forward-chat-list" style="max-height: 400px; overflow-y: auto; margin: 15px 0;">
                <!-- 对话列表将动态生成 -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" id="confirm-forward-btn" style="flex: 1;">确认转发</button>
                <button class="btn btn-secondary" id="cancel-forward-btn" style="flex: 1;">取消</button>
            </div>
        </div>
    </div>
    <!-- Create New Member for Group Modal -->
    <div id="create-member-for-group-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3>创建新角色并加入群聊</h3>
            <form id="create-member-for-group-form">
                <div class="form-group">
                    <label>新成员头像</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像" id="create-group-member-avatar-preview" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                        <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                        <label for="create-group-member-avatar-upload" class="btn btn-secondary" style="flex: 1; margin: 0; cursor: pointer;">选择头像</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="create-group-member-nickname">群昵称</label>
                    <input type="text" id="create-group-member-nickname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-realname">真名</label>
                    <input type="text" id="create-group-member-realname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-persona">人设</label>
                    <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。" style="min-height: 120px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">创建并加入</button>
            </form>
        </div>
    </div>
    
    <!-- AI Generate Group Member Modal -->
    <div id="ai-generate-group-member-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">AI生成群成员</h3>
            <form id="ai-generate-group-member-form">
                <div class="form-group">
                    <label for="ai-gen-gm-must-have">必须有的特征</label>
                    <textarea id="ai-gen-gm-must-have" placeholder="例如：女性、温柔、喜欢读书、长发..." style="min-height: 80px;"></textarea>
                    <small style="color: #888; font-size: 12px;">生成的角色必须包含这些特征（可选填）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-gm-must-not-have">不希望有的特征</label>
                    <textarea id="ai-gen-gm-must-not-have" placeholder="例如：暴力、粗鲁、冷漠..." style="min-height: 80px;"></textarea>
                    <small style="color: #888; font-size: 12px;">生成的角色绝对不能包含这些特征（可选填）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-gm-word-count">生成字数</label>
                    <input type="number" id="ai-gen-gm-word-count" placeholder="例如：500" min="100" max="5000" step="50">
                    <small style="color: #888; font-size: 12px;">角色人设的字数，留空则自动决定（建议300-1000字）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-gm-template">角色模板（JSON格式）</label>
                    <textarea id="ai-gen-gm-template" placeholder='例如：{"name": "", "age": "", "personality": "", "background": ""}' style="min-height: 100px; font-family: monospace; font-size: 13px;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <input type="file" id="ai-gen-gm-template-file" accept=".txt,.docx" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="upload-gm-template-btn" style="width: 50%; padding: 8px; font-size: 13px;">从文件导入模板</button>
                        <button type="button" class="btn btn-secondary" id="clear-gm-template-btn" style="width: 50%; padding: 8px; font-size: 13px;">清空</button>
                    </div>
                    <small style="color: #888; font-size: 12px;">自定义角色卡格式，留空则使用默认格式（支持TXT、DOCX文件）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-gm-system-prompt">AI系统词语（选填）</label>
                    <textarea id="ai-gen-gm-system-prompt" placeholder="例如：请使用优雅的文风、注重细节描写、保持角色一致性..." style="min-height: 100px;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <input type="file" id="ai-gen-gm-system-prompt-file" accept=".txt,.docx" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="upload-gm-system-prompt-btn" style="width: 50%; padding: 8px; font-size: 13px;">从文件导入</button>
                        <button type="button" class="btn btn-secondary" id="clear-gm-system-prompt-btn" style="width: 50%; padding: 8px; font-size: 13px;">清空</button>
                    </div>
                    <div style="margin-top: 8px;">
                        <label style="font-size: 13px; color: #666;">系统词位置：</label>
                        <div style="display: flex; gap: 8px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-gm-system-position" value="before" checked style="margin-right: 5px;">
                                <span style="font-size: 13px;">前面</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-gm-system-position" value="middle" style="margin-right: 5px;">
                                <span style="font-size: 13px;">中间</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-gm-system-position" value="after" style="margin-right: 5px;">
                                <span style="font-size: 13px;">后面</span>
                            </label>
                        </div>
                    </div>
                    <small style="color: #888; font-size: 12px;">添加AI人格化的系统词或文风指导，可以影响生成的角色风格（支持TXT、DOCX文件）</small>
                </div>
                
                <div class="form-group">
                    <label>选择API</label>
                    <div style="display: flex; gap: 10px;">
                        <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="ai-gen-gm-api-type" value="main" checked style="margin-right: 8px;">
                            <span>主API</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="ai-gen-gm-api-type" value="secondary" style="margin-right: 8px;">
                            <span>副API</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-gm-count">生成数量</label>
                    <input type="number" id="ai-gen-gm-count" value="1" min="1" max="10" required>
                    <small style="color: #888; font-size: 12px;">一次生成几个群成员（1-10个）</small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">开始生成</button>
                    <button type="button" class="btn btn-secondary" id="close-ai-generate-gm-modal" style="flex: 1;">取消</button>
                </div>
            </form>
            
            <div id="ai-gen-gm-result" style="margin-top: 20px; display: none;">
                <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
                <h4 style="color: var(--primary-color);">生成结果</h4>
                <div id="ai-gen-gm-result-content" style="max-height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px; font-size: 14px; line-height: 1.6;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Theme Preset Modal -->
    <div id="delete-theme-preset-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>删除主题颜色预设</h3>
            <div class="wb-select-all-container">
                <input type="checkbox" id="theme-preset-select-all">
                <label for="theme-preset-select-all">全选</label>
            </div>
            <ul id="theme-preset-delete-list" style="list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto;"></ul>
            <button class="btn btn-danger" id="confirm-delete-theme-preset-btn" style="margin-top: 20px;">确认删除</button>
            <button class="btn btn-neutral" id="cancel-delete-theme-preset-btn" style="margin-top: 10px;">取消</button>
        </div>
    </div>
    <!-- Delete Bubble Style Preset Modal -->
    <div id="delete-bubble-style-preset-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>删除气泡样式预设</h3>
            <div class="wb-select-all-container">
                <input type="checkbox" id="bubble-style-preset-select-all">
                <label for="bubble-style-preset-select-all">全选</label>
            </div>
            <ul id="bubble-style-preset-delete-list" style="list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto;"></ul>
            <button class="btn btn-danger" id="confirm-delete-bubble-style-preset-btn" style="margin-top: 20px;">确认删除</button>
            <button class="btn btn-neutral" id="cancel-delete-bubble-style-preset-btn" style="margin-top: 10px;">取消</button>
        </div>
    </div>
    <!-- Memory Summary Name Modal -->
    <div id="memory-summary-name-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>总结记忆命名</h3>
            <form id="memory-summary-name-form">
                <div class="form-group">
                    <label for="memory-summary-name-input">记忆名称</label>
                    <input type="text" id="memory-summary-name-input" placeholder="留空使用默认名称">
                    <small style="color: #666; display: block; margin-top: 5px;">默认格式: 记忆_日期时间</small>
                </div>
                <button type="submit" class="btn btn-primary">确认</button>
                <button type="button" class="btn btn-neutral" id="cancel-memory-name-btn" style="margin-top: 10px;">取消</button>
            </form>
        </div>
    </div>
    <!-- Memory Summary View Modal -->
    <div id="memory-summary-view-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px;">
            <h3 id="memory-summary-view-title">记忆详情</h3>
            <div style="background-color: #f5f5f5; border-radius: 8px; padding: 15px; margin: 15px 0;">
                <div style="margin-bottom: 10px;">
                    <strong style="color: #666;">创建时间：</strong>
                    <span id="memory-summary-view-time" style="color: #333;"></span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong style="color: #666;">总结条数：</strong>
                    <span id="memory-summary-view-count" style="color: #333;"></span>
                </div>
                <div>
                    <strong style="color: #666; display: block; margin-bottom: 8px;">总结内容：</strong>
                    <textarea id="memory-summary-view-content" rows="10" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; line-height: 1.6; font-size: 14px;"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" id="save-memory-summary-btn" style="flex: 1;">保存修改</button>
                <button class="btn btn-danger" id="delete-memory-summary-btn" style="flex: 1;">删除此记忆</button>
                <button class="btn btn-neutral" id="close-memory-view-btn" style="flex: 1;">关闭</button>
            </div>
        </div>
    </div>
    <!-- Manual Summary Selection Modal -->
    <div id="manual-summary-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>手动总结</h3>
            <div style="margin: 20px 0;">
                <button class="btn btn-primary" id="quick-summary-btn" style="width: 100%; margin-bottom: 10px; padding: 12px;">
                    立刻总结（从开始到设定条数）
                </button>
                <button class="btn btn-secondary" id="custom-range-summary-btn" style="width: 100%; padding: 12px;">
                    自定义范围总结
                </button>
            </div>
            <button class="btn btn-neutral" id="cancel-manual-summary-btn" style="width: 100%;">取消</button>
        </div>
    </div>
    <!-- Custom Range Summary Modal -->
    <div id="custom-range-summary-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>自定义范围总结</h3>
            <form id="custom-range-summary-form">
                <div class="form-group">
                    <label for="summary-range-input">输入范围</label>
                    <input type="text" id="summary-range-input" placeholder="例如: 1-20" required>
                    <small style="color: #666; display: block; margin-top: 5px;">格式：起始条数-结束条数（例如：1-20）</small>
                </div>
                <button type="submit" class="btn btn-primary">确认总结</button>
                <button type="button" class="btn btn-neutral" id="cancel-range-summary-btn" style="margin-top: 10px;">取消</button>
            </form>
        </div>
    </div>
    <!-- Memory Library Content Modal -->
    <div id="memory-library-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 700px; max-height: 80vh;">
            <h3 id="memory-library-title" style="margin-bottom: 10px;">记忆库内容</h3>
            <button class="btn btn-success" id="compress-memory-btn" style="width: 100%; margin-bottom: 10px;">压缩记忆</button>
            <button class="btn btn-danger" id="manage-memory-delete-btn-new" style="width: 100%; margin-bottom: 15px;">管理删除</button>
            <div style="margin: 15px 0;">
                <div id="memory-library-list" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background-color: white;">
                    <div style="color: #999; text-align: center; padding: 20px;">暂无记忆</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-neutral" id="close-memory-library-btn">关闭</button>
            </div>
        </div>
    </div>
    <!-- Delete Memory Selection Modal -->
    <div id="delete-memory-select-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 700px; max-height: 80vh;">
            <h3 style="margin-bottom: 15px;">管理删除</h3>
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #f5f5f5; border-radius: 4px; margin-bottom: 10px;">
                    <span style="font-weight: bold;">已选择: <span id="delete-selected-count">0</span> 条记忆</span>
                    <button class="btn btn-secondary" id="delete-select-all-btn" style="padding: 4px 12px;">全选</button>
                </div>
                <div id="delete-memory-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background-color: white;">
                    <div style="color: #999; text-align: center; padding: 20px;">暂无记忆</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" id="confirm-delete-btn">删除选中记忆</button>
                <button class="btn btn-neutral" id="cancel-delete-btn">取消</button>
            </div>
        </div>
    </div>

    <!-- Compress Memory Selection Modal -->
    <div id="compress-memory-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 700px; max-height: 80vh;">
            <h3 style="margin-bottom: 15px;">压缩记忆</h3>
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #f5f5f5; border-radius: 4px; margin-bottom: 10px;">
                    <span style="font-weight: bold;">已选择: <span id="compress-selected-count">0</span> 条记忆</span>
                    <button class="btn btn-secondary" id="compress-select-all-btn" style="padding: 4px 12px;">全选</button>
                </div>
                <div id="compress-memory-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background-color: white;">
                    <div style="color: #999; text-align: center; padding: 20px;">暂无记忆</div>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="keep-original-memories" checked>
                    <span>保留原始记忆（不勾选则压缩后自动删除原记忆）</span>
                </label>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" id="confirm-compress-btn">开始压缩</button>
                <button class="btn btn-neutral" id="cancel-compress-btn">取消</button>
            </div>
        </div>
    </div>
    <!-- Persona Presets Management Modal -->
    <div id="persona-presets-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 80vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">人设预设</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" id="import-persona-json-btn" style="padding: 6px 12px;">导入JSON</button>
                    <button class="btn btn-primary" id="add-new-persona-preset-btn" style="padding: 6px 12px;">添加预设</button>
                </div>
            </div>
            <input type="file" id="import-persona-json-input" accept=".json" style="display: none;">
            <div id="persona-presets-list" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background-color: white;">
                <div style="color: #999; text-align: center; padding: 20px;">暂无人设预设</div>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-neutral" id="close-persona-presets-btn">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Persona Preset Modal -->
    <div id="edit-persona-preset-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px;">
            <h3 id="edit-persona-preset-title">添加人设预设</h3>
            <form id="edit-persona-preset-form">
                <input type="hidden" id="edit-persona-preset-id">
                <div class="form-group">
                    <label for="persona-preset-name">预设名称</label>
                    <input type="text" id="persona-preset-name" placeholder="例如：朱梦佳" required>
                </div>
                <div class="form-group">
                    <label>预设头像</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="https://i.postimg.cc/GtbTnxhP/o-o-1.jpg" alt="预设头像" id="persona-preset-avatar-preview" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                        <input type="file" id="persona-preset-avatar-upload" accept="image/*" style="display:none;">
                        <label for="persona-preset-avatar-upload" class="btn btn-secondary" style="flex: 1; margin: 0;">选择头像</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="persona-preset-description">人设描述</label>
                    <textarea id="persona-preset-description" rows="8" placeholder="详细描述人设特点..." required></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">保存</button>
                    <button type="button" class="btn btn-neutral" id="cancel-edit-persona-preset-btn">取消</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NPC Library Management Modal -->
    <div id="npc-library-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 80vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">NPC库</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="select-all-npcs-btn" style="padding: 6px 12px; display: none;">全选</button>
                    <button class="btn btn-danger" id="delete-selected-npcs-btn" style="padding: 6px 12px; display: none;">删除选中</button>
                    <button class="btn btn-secondary" id="toggle-npc-select-mode-btn" style="padding: 6px 12px;">选择</button>
                    <button class="btn btn-success" id="add-new-npc-btn" style="padding: 6px 12px;">添加NPC</button>
                    <button class="btn btn-neutral" id="close-npc-library-btn" style="padding: 6px 12px;">关闭</button>
                </div>
            </div>
            <div id="npc-library-list" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background-color: white;">
                <div style="color: #999; text-align: center; padding: 20px;">暂无NPC</div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit NPC Modal -->
    <div id="edit-npc-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <h3 id="edit-npc-title">添加NPC</h3>
            <form id="edit-npc-form">
                <input type="hidden" id="edit-npc-id">
                <div class="form-group">
                    <label for="npc-name">NPC名字</label>
                    <input type="text" id="npc-name" required>
                </div>
                <div class="form-group">
                    <label>NPC头像</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="https://i.postimg.cc/GtbTnxhP/o-o-1.jpg" alt="NPC头像" id="npc-avatar-preview" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                        <input type="file" id="npc-avatar-upload" accept="image/*" style="display:none;">
                        <label for="npc-avatar-upload" class="btn btn-secondary" style="flex: 1; margin: 0;">选择头像</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="npc-description">NPC人设</label>
                    <textarea id="npc-description" rows="6" placeholder="详细描述NPC的性格、背景等..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="npc-relation-to-char">与角色的关系（选填）</label>
                    <input type="text" id="npc-relation-to-char" placeholder="例如：朋友、同事、邻居...">
                    <small style="color: #888; font-size: 12px;">帮助AI理解NPC与该角色的关系</small>
                </div>
                <div class="form-group">
                    <label for="npc-relation-to-user">与用户的关系（选填）</label>
                    <input type="text" id="npc-relation-to-user" placeholder="例如：陌生人、熟人...">
                    <small style="color: #888; font-size: 12px;">帮助AI理解NPC与用户的关系</small>
                </div>
                
                <hr style="opacity: 0.2; margin: 20px 0;">
                
                <div class="form-group" id="npc-global-toggle-group">
                    <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="npc-global-toggle" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600;">全局NPC</span>
                    </label>
                    <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">开启后将此NPC添加到所有角色的NPC库中</small>
                </div>
                
                <div class="form-group" id="npc-select-chars-group">
                    <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="npc-select-chars-toggle" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600;">选择角色互通NPC</span>
                    </label>
                    <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">开启后可选择特定角色同步添加此NPC，而不是全局添加</small>
                    
                    <div id="npc-chars-selection" style="display: none; margin-top: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background-color: #f9f9f9;">
                        <!-- 角色列表将动态生成 -->
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
                    <button type="button" class="btn btn-neutral" id="cancel-edit-npc-btn" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- AI Generate NPC Modal -->
    <div id="ai-generate-npc-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">AI生成NPC</h3>
            <form id="ai-generate-npc-form">
                <div class="form-group">
                    <label for="ai-gen-npc-must-have">必须有的特征</label>
                    <textarea id="ai-gen-npc-must-have" placeholder="例如：友善、幽默、专业..." style="min-height: 80px;"></textarea>
                    <small style="color: #888; font-size: 12px;">生成的NPC必须包含这些特征（可选填）</small>
                </div>
                <div class="form-group">
                    <label for="ai-gen-npc-must-not-have">不希望有的特征</label>
                    <textarea id="ai-gen-npc-must-not-have" placeholder="例如：暴力、粗鲁..." style="min-height: 80px;"></textarea>
                    <small style="color: #888; font-size: 12px;">生成的NPC绝对不能包含这些特征（可选填）</small>
                </div>
                <div class="form-group">
                    <label for="ai-gen-npc-word-count">生成字数</label>
                    <input type="number" id="ai-gen-npc-word-count" placeholder="例如：200" min="100" max="5000" step="50">
                    <small style="color: #888; font-size: 12px;">NPC人设的字数，留空则自动决定（建议150-500字）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-npc-template">NPC模板</label>
                    <textarea id="ai-gen-npc-template" placeholder="例如：姓名、职业、性格、背景..." style="min-height: 80px; font-family: monospace; font-size: 13px;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <input type="file" id="ai-gen-npc-template-file" accept=".txt,.docx" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="upload-npc-template-btn" style="width: 50%; padding: 8px; font-size: 13px;">从文件导入模板</button>
                        <button type="button" class="btn btn-secondary" id="clear-npc-template-btn" style="width: 50%; padding: 8px; font-size: 13px;">清空</button>
                    </div>
                    <small style="color: #888; font-size: 12px;">自定义NPC格式，留空则使用默认格式（支持TXT、DOCX文件）</small>
                </div>
                
                <div class="form-group">
                    <label for="ai-gen-npc-system-prompt">AI系统词语（选填）</label>
                    <textarea id="ai-gen-npc-system-prompt" placeholder="例如：请使用优雅的文风、注重细节描写、保持角色一致性..." style="min-height: 100px;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <input type="file" id="ai-gen-npc-system-prompt-file" accept=".txt,.docx" style="display: none;">
                        <button type="button" class="btn btn-secondary" id="upload-npc-system-prompt-btn" style="width: 50%; padding: 8px; font-size: 13px;">从文件导入</button>
                        <button type="button" class="btn btn-secondary" id="clear-npc-system-prompt-btn" style="width: 50%; padding: 8px; font-size: 13px;">清空</button>
                    </div>
                    <div style="margin-top: 8px;">
                        <label style="font-size: 13px; color: #666;">系统词位置：</label>
                        <div style="display: flex; gap: 8px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-npc-system-position" value="before" checked style="margin-right: 5px;">
                                <span style="font-size: 13px;">前面</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-npc-system-position" value="middle" style="margin-right: 5px;">
                                <span style="font-size: 13px;">中间</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="ai-gen-npc-system-position" value="after" style="margin-right: 5px;">
                                <span style="font-size: 13px;">后面</span>
                            </label>
                        </div>
                    </div>
                    <small style="color: #888; font-size: 12px;">添加AI人格化的系统词或文风指导，可以影响生成的NPC风格（支持TXT、DOCX文件）</small>
                </div>
                
                <div class="form-group">
                    <label>选择API</label>
                    <div style="display: flex; gap: 10px;">
                        <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="ai-gen-npc-api-type" value="main" checked style="margin-right: 8px;">
                            <span>主API</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="ai-gen-npc-api-type" value="secondary" style="margin-right: 8px;">
                            <span>副API</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ai-gen-npc-count">生成数量</label>
                    <input type="number" id="ai-gen-npc-count" value="1" min="1" max="10" required>
                    <small style="color: #888; font-size: 12px;">一次生成几个NPC（1-10个）</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">开始生成</button>
                    <button type="button" class="btn btn-secondary" id="close-ai-generate-npc-modal" style="flex: 1;">取消</button>
                </div>
            </form>
            <div id="ai-gen-npc-result" style="margin-top: 20px; display: none;">
                <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
                <h4 style="color: var(--primary-color);">生成结果</h4>
                <div id="ai-gen-npc-result-content" style="max-height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px; font-size: 14px; line-height: 1.6;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Convert CHAR to NPC Modal -->
    <div id="convert-char-to-npc-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px; max-height: 80vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">转换CHAR为NPC</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="convert-char-select-all-btn" style="padding: 6px 12px;">全选</button>
                    <button class="btn btn-success" id="convert-char-confirm-btn" style="padding: 6px 12px;">确认转换</button>
                    <button class="btn btn-neutral" id="close-convert-char-modal-btn" style="padding: 6px 12px;">取消</button>
                </div>
            </div>
            <small style="color: #888; font-size: 12px; display: block; margin-bottom: 15px;">
                选择要转换为NPC的角色，转换后将使用角色的名称、头像和人设作为NPC信息
            </small>
            <div id="convert-char-list" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background-color: white;">
                <div style="color: #999; text-align: center; padding: 20px;">暂无可转换的角色</div>
            </div>
        </div>
    </div>

    <!-- 互相转换确认弹窗 -->
    <div id="mutual-convert-confirm-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 450px;">
            <h3 style="margin-top: 0;">互相转换确认</h3>
            <div style="margin: 20px 0;">
                <p style="font-size: 15px; line-height: 1.6; color: #333;">
                    是否要将双方互相添加到对方的NPC库中？
                </p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p style="margin: 0 0 10px 0; font-size: 14px; color: #666;">
                        <strong>✓ 选择"是"：</strong>
                    </p>
                    <p style="margin: 0 0 5px 0; font-size: 13px; color: #666; padding-left: 20px;">
                        • 当前角色的NPC库会添加选中的角色
                    </p>
                    <p style="margin: 0 0 15px 0; font-size: 13px; color: #666; padding-left: 20px;">
                        • 选中角色的NPC库也会添加当前角色
                    </p>
                    <p style="margin: 0 0 10px 0; font-size: 14px; color: #666;">
                        <strong>✗ 选择"否"：</strong>
                    </p>
                    <p style="margin: 0; font-size: 13px; color: #666; padding-left: 20px;">
                        • 仅在当前角色的NPC库添加选中的角色
                    </p>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" id="mutual-convert-no-btn" style="padding: 10px 20px;">否</button>
                <button class="btn btn-primary" id="mutual-convert-yes-btn" style="padding: 10px 20px;">是</button>
            </div>
        </div>
    </div>
    

    
    <!-- Select Personas to Import Modal -->
    <div id="select-personas-import-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 600px;">
            <h3>选择要导入的人设</h3>
            <div style="margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">
                    <label style="margin: 0; cursor: pointer; display: flex; align-items: center;">
                        <input type="checkbox" id="persona-import-select-all" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                        <strong>全选</strong>
                    </label>
                    <span id="persona-import-selected-count" style="color: #666; font-size: 14px;">已选择 0 项</span>
                </div>
                <div id="persona-import-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background-color: white;">
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" id="confirm-import-personas-btn">导入选中项</button>
                <button class="btn btn-neutral" id="cancel-import-personas-btn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Memory Summaries Modal -->
    <div id="delete-memory-summaries-modal" class="modal-overlay">
        <div class="modal-window" style="max-width: 500px;">
            <h3>删除记忆</h3>
            <div style="margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">
                    <label style="margin: 0; cursor: pointer; display: flex; align-items: center;">
                        <input type="checkbox" id="memory-select-all" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                        <strong>全选</strong>
                    </label>
                    <span id="memory-selected-count" style="color: #666; font-size: 14px;">已选择 0 项</span>
                </div>
                <div id="memory-delete-list" style="max-height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background-color: white;">
                    <div style="color: #999; text-align: center; padding: 20px;">暂无记忆</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" id="confirm-delete-memories-btn">删除选中</button>
                <button class="btn btn-neutral" id="cancel-delete-memories-btn">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- Avatar Frame Modal -->
<div id="avatar-frame-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 600px; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">选择头像框</h3>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="upload-frame-btn" style="padding: 6px 12px; font-size: 13px;">上传</button>
                <button class="btn btn-secondary" id="import-frames-btn" style="padding: 6px 12px; font-size: 13px;">导入</button>
                <button class="btn btn-secondary" id="export-frames-btn" style="padding: 6px 12px; font-size: 13px;">导出</button>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
            <div class="frame-tabs">
                <div id="ai-frame-tab" class="frame-tab active">对方的</div>
                <div id="my-frame-tab" class="frame-tab">我的</div>
            </div>
            <div id="ai-frame-content" class="frame-content">
                <div id="ai-frame-grid" class="frame-grid">
                </div>
            </div>
            <div id="my-frame-content" class="frame-content" style="display: none;">
                <div id="my-frame-grid" class="frame-grid">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px; padding: 15px; border-top: 1px solid #eee; flex-shrink: 0;">
                <button class="btn btn-secondary" id="cancel-frame-settings-btn" style="flex: 1;">取消</button>
                <button class="btn btn-primary" id="save-frame-settings-btn" style="flex: 1;">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 上传头像框弹窗 -->
<div id="upload-frame-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 500px;">
        <h3>上传头像框</h3>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: 500;">选择上传方式：</label>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" id="upload-local-btn" style="flex: 1;">本地上传</button>
                <button class="btn btn-secondary" id="upload-url-btn" style="flex: 1;">URL上传</button>
            </div>
        </div>
        
        <!-- 本地上传区域 -->
        <div id="local-upload-area" style="display: none;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">选择图片文件：</label>
            <input type="file" id="local-frame-input" accept="image/*" multiple style="margin-bottom: 15px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">命名（用逗号分隔，留空则自动命名）：</label>
            <input type="text" id="local-frame-names" placeholder="例如：头像框1,头像框2,头像框3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
        </div>
        
        <!-- URL上传区域 -->
        <div id="url-upload-area" style="display: none;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">输入图片URL（用逗号分隔）：</label>
            <textarea id="url-frame-input" placeholder="例如：https://example.com/1.gif,https://example.com/2.gif" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; min-height: 100px; margin-bottom: 15px;"></textarea>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">命名（用逗号分隔，留空则自动命名）：</label>
            <input type="text" id="url-frame-names" placeholder="例如：头像框1,头像框2,头像框3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" id="cancel-upload-frame-btn" style="flex: 1;">取消</button>
            <button class="btn btn-primary" id="confirm-upload-frame-btn" style="flex: 1;">确认上传</button>
        </div>
    </div>
</div>

<input type="file" id="import-data-input" accept=".ee" style="display: none;">
<input type="file" id="import-frames-input" accept=".json" style="display: none;">

<!-- 音乐播放器 -->
<audio id="audio-player" style="display: none;"></audio>
<div id="music-player-overlay">
    <div class="music-player-window">
        
        <!-- 1. 顶部操作栏 -->
        <div class="music-player-top-actions">
            <div class="top-left-cluster">
                <button id="music-return-btn">‹</button>
                <button id="music-exit-btn">×</button>
            </div>
            <span id="music-playlist-btn">☰</span>
        </div>
        
        <!-- 2. 歌曲信息 -->
        <div id="music-avatars-container">
            <img id="music-user-avatar" class="music-avatar" src="https://i.postimg.cc/GtbTnxhP/o-o-1.jpg" alt="我的头像">
            <img id="music-char-avatar" class="music-avatar" src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="角色头像">
        </div>
        <div id="music-time-counter">已经一起听了0.0小时</div>
        <div id="music-player-song-title">请添加歌曲</div>
        <div id="music-player-artist">...</div>
        
        <!-- 3. 胶片/歌词切换容器 -->
        <div id="music-visual-container">
            <!-- 胶片视图 -->
            <div id="vinyl-view">
                <img id="music-player-cover" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg" alt="Album Art">
            </div>
            <!-- 歌词视图 -->
            <div id="inline-lyrics-view">
                <div id="music-lyrics-container">
                    <div id="music-lyrics-list">
                        <!-- 歌词将由JS动态生成在这里 -->
                        <div class="lyric-line">♪ 暂无歌词 ♪</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 4. 播放控制区的包裹容器 -->
        <div class="music-player-controls-wrapper">
            <!-- a. iOS风格进度条 -->
            <div class="music-progress-bar-container">
                <div id="music-current-time" class="time-display">0:00</div>
                <div class="progress-bar">
                    <div id="music-progress-fill" class="progress-bar-fill"></div>
                </div>
                <div id="music-total-time" class="time-display">0:00</div>
            </div>
            
            <!-- b. 播放控制按钮 -->
            <div class="music-controls">
                <button id="music-prev-btn">◀</button>
                <button id="music-play-pause-btn" class="play-pause-btn">▶</button>
                <button id="music-next-btn">▶</button>
                <button id="music-mode-btn">顺序</button>
            </div>
        </div>

    </div>
</div>

<div id="music-playlist-panel">
    <div class="playlist-header">
        <div class="playlist-header-left">
            <span class="panel-btn" id="close-playlist-btn">返回</span>
            <span class="panel-btn" id="manage-playlist-btn">管理</span>
        </div>
        <span>播放列表</span>
        <div class="playlist-header-right">
            <span class="panel-btn" id="clean-invalid-songs-btn">清理</span>
            <span class="panel-btn" id="add-song-upload-btn">上传</span>
            <span class="panel-btn" id="add-song-search-btn">搜索</span>
        </div>
    </div>
    <div class="playlist-manage-bar" id="playlist-manage-bar">
        <div class="playlist-manage-actions">
            <button class="panel-btn" id="select-all-playlist-btn" style="font-size: 13px; padding: 6px 12px;">全选</button>
            <button class="panel-btn" id="delete-selected-playlist-btn" style="font-size: 13px; padding: 6px 12px; background: rgba(255, 107, 107, 0.15); color: #ff6b6b; font-weight: 600;">删除选中</button>
        </div>
        <span id="selected-count" style="font-size: 13px; color: #888; font-weight: 500;">已选中 0 首</span>
    </div>
    <div class="playlist-body" id="playlist-body"></div>
</div>
<input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
<input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">

<!-- 上传选项弹窗 -->
<div id="upload-options-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: rgba(255, 255, 255, 0.95); width: 90%; max-width: 380px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);">
        <div style="padding: 20px 24px; background: rgba(248, 249, 250, 0.6); color: #333; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.06);">
            <h3 style="margin: 0; font-size: 17px; font-weight: 500; color: #1a1a1a;">上传音乐</h3>
            <button id="close-upload-modal" style="background: rgba(0,0,0,0.04); border: none; font-size: 22px; cursor: pointer; color: #666; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">&times;</button>
        </div>
        <div style="padding: 20px 24px; display: flex; flex-direction: column; gap: 10px;">
            <button class="upload-modal-option" data-type="local" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s; backdrop-filter: blur(5px);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span>本地上传</span>
            </button>
            <button class="upload-modal-option" data-type="url" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s; backdrop-filter: blur(5px);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
                <span>URL上传</span>
            </button>
        </div>
    </div>
</div>

<!-- 歌词导入弹窗 -->
<div id="lyrics-import-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: rgba(255, 255, 255, 0.95); width: 90%; max-width: 380px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);">
        <div style="padding: 20px 24px; background: rgba(248, 249, 250, 0.6); color: #333; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.06);">
            <h3 style="margin: 0; font-size: 17px; font-weight: 500; color: #1a1a1a;">导入歌词</h3>
            <button id="close-lyrics-modal" style="background: rgba(0,0,0,0.04); border: none; font-size: 22px; cursor: pointer; color: #666; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">&times;</button>
        </div>
        <div style="padding: 20px 24px; display: flex; flex-direction: column; gap: 10px;">
            <button class="lyrics-modal-option" data-type="file" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s; backdrop-filter: blur(5px);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
                <span>从文件导入</span>
            </button>
            <button class="lyrics-modal-option" data-type="url" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s; backdrop-filter: blur(5px);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
                <span>从网址导入</span>
            </button>
        </div>
    </div>
</div>

<!-- 封面上传弹窗 -->
<div id="cover-import-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: rgba(255, 255, 255, 0.95); width: 90%; max-width: 380px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);">
        <div style="padding: 20px 24px; background: rgba(248, 249, 250, 0.6); color: #333; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.06);">
            <h3 style="margin: 0; font-size: 17px; font-weight: 500; color: #1a1a1a;">封面设置</h3>
            <button id="close-cover-modal" style="background: rgba(0,0,0,0.04); border: none; font-size: 22px; cursor: pointer; color: #666; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">&times;</button>
        </div>
        <div style="padding: 20px 24px; display: flex; flex-direction: column; gap: 10px;">
            <button class="cover-modal-option" data-type="file" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s; backdrop-filter: blur(5px);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <span>本地上传</span>
            </button>
            <button class="cover-modal-option" data-type="url" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s; backdrop-filter: blur(5px);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
                <span>URL上传</span>
            </button>
            <button class="cover-modal-option" data-type="reset" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #666; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s; backdrop-filter: blur(5px);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <polyline points="23 20 23 14 17 14"></polyline>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
                <span>重置为默认封面</span>
            </button>
        </div>
    </div>
</div>

<!-- 播放列表管理弹窗 -->
<div id="playlist-manage-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 10001; pointer-events: none;">
    <div class="modal-content-wrapper" style="background: rgba(255, 255, 255, 0.95); width: 90%; max-width: 380px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); pointer-events: auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: none;">
        <div class="modal-header-drag-handle" style="padding: 8px 0; background: rgba(248, 249, 250, 0.6); display: flex; justify-content: center; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.06); cursor: move;">
            <div class="drag-indicator" style="width: 36px; height: 4px; background: rgba(0, 0, 0, 0.2); border-radius: 2px;"></div>
        </div>
        <div style="padding: 16px 24px; background: rgba(248, 249, 250, 0.6); color: #333; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.06);">
            <h3 style="margin: 0; font-size: 17px; font-weight: 500; color: #1a1a1a;">播放列表管理</h3>
            <button id="close-manage-modal" style="background: rgba(0,0,0,0.04); border: none; font-size: 22px; cursor: pointer; color: #666; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">&times;</button>
        </div>
        <div style="padding: 20px 24px; display: flex; flex-direction: column; gap: 10px;">
            <button class="manage-modal-option" data-action="time-settings" style="padding: 14px 18px; background: rgba(108, 99, 255, 0.1); color: #6c63ff; border: 1px solid rgba(108, 99, 255, 0.2); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>听歌时长设置</span>
            </button>
            <button class="manage-modal-option" data-action="delete" style="padding: 14px 18px; background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.2); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                <span>删除选中歌曲</span>
            </button>
            <button class="manage-modal-option" data-action="move-up" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
                <span>上移选中歌曲</span>
            </button>
            <button class="manage-modal-option" data-action="move-down" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <span>下移选中歌曲</span>
            </button>
            <button class="manage-modal-option" data-action="select-all" style="padding: 14px 18px; background: rgba(255, 255, 255, 0.5); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
                <span>全选</span>
            </button>
        </div>
        <div style="padding: 12px 24px; background: rgba(248, 249, 250, 0.4); border-top: 1px solid rgba(0,0,0,0.06); text-align: center;">
            <span id="manage-selected-count" style="font-size: 13px; color: #888; font-weight: 500;">已选中 0 首</span>
        </div>
    </div>
</div>

<!-- 听歌时长设置弹窗 -->
<div id="time-settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 10002; pointer-events: none;">
    <div class="modal-content-wrapper" style="background: rgba(255, 255, 255, 0.95); width: 90%; max-width: 380px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); pointer-events: auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div class="modal-header-drag-handle" style="padding: 8px 0; background: rgba(248, 249, 250, 0.6); display: flex; justify-content: center; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.06); cursor: move;">
            <div class="drag-indicator" style="width: 36px; height: 4px; background: rgba(0, 0, 0, 0.2); border-radius: 2px;"></div>
        </div>
        <div style="padding: 16px 24px; background: rgba(248, 249, 250, 0.6); color: #333; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.06);">
            <h3 style="margin: 0; font-size: 17px; font-weight: 500; color: #1a1a1a;">听歌时长设置</h3>
            <button id="close-time-settings" style="background: rgba(0,0,0,0.04); border: none; font-size: 22px; cursor: pointer; color: #666; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">&times;</button>
        </div>
        <div style="padding: 20px 24px; display: flex; flex-direction: column; gap: 10px;">
            <button class="time-settings-option" data-action="toggle-unit" style="padding: 14px 18px; background: rgba(108, 99, 255, 0.1); color: #6c63ff; border: 1px solid rgba(108, 99, 255, 0.2); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                <div style="flex: 1; text-align: left;">
                    <div style="font-size: 15px; font-weight: 400;">切换显示单位</div>
                    <div id="current-unit-hint" style="font-size: 13px; opacity: 0.6; font-weight: 400; margin-top: 2px;">当前显示：小时</div>
                </div>
            </button>
            <button class="time-settings-option" data-action="reset-time" style="padding: 14px 18px; background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.2); border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 400; display: flex; align-items: center; gap: 12px; transition: all 0.25s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                    <path d="M3 21v-5h5"></path>
                </svg>
                <div style="flex: 1; text-align: left;">
                    <div style="font-size: 15px; font-weight: 400;">重置时长</div>
                    <div style="font-size: 13px; opacity: 0.6; font-weight: 400; margin-top: 2px;">将听歌时长清零</div>
                </div>
            </button>
        </div>
        <div style="padding: 12px 24px; background: rgba(248, 249, 250, 0.4); border-top: 1px solid rgba(0,0,0,0.06); text-align: center;">
            <span style="font-size: 13px; color: #888; font-weight: 500;">💡 提示：切换单位不会影响实际时长数据</span>
        </div>
    </div>
</div>

<!-- 清理无效歌曲结果弹窗 -->
<div id="clean-result-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 500px; max-height: 70vh; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="padding: 15px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h3 style="margin: 0; font-size: 18px;">清理结果</h3>
            </div>
            <button id="close-clean-result" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #888;">&times;</button>
        </div>
        <div id="clean-result-content" style="flex: 1; overflow-y: auto; padding: 15px;">
            <div id="clean-result-summary" style="padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px; color: #555;"></div>
            <div id="invalid-songs-list" style="display: flex; flex-direction: column; gap: 8px;"></div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #f0f0f0; display: flex; gap: 10px;">
            <button id="select-all-invalid" style="flex: 1; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">全选</button>
            <button id="research-selected-songs" style="flex: 2; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">重新搜索选中</button>
        </div>
    </div>
</div>

<!-- API选择弹窗 -->
<div id="api-selector-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002; align-items: center; justify-content: center;">
    <div style="background: white; width: 85%; max-width: 350px; border-radius: 18px; overflow: hidden; animation: slideUp 0.3s ease;">
        <div style="padding: 20px; text-align: center; border-bottom: 1px solid #f0f0f0;">
            <h3 style="margin: 0; font-size: 18px; color: var(--primary-color);">选择音乐API</h3>
            <p style="margin: 10px 0 0 0; font-size: 13px; color: #888;">请选择要使用的音乐搜索接口</p>
        </div>
        <div style="padding: 20px; display: flex; flex-direction: column; gap: 12px;">
            <button id="select-old-api" style="padding: 15px; background: #ff80ab; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s;">
                旧版API (vkeys)
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px; opacity: 0.9;">支持：网易云、QQ音乐</div>
            </button>
            <button id="select-new-api" style="padding: 15px; background: #90caf9; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s;">
                新版API (Meting)
                <div style="font-size: 12px; font-weight: normal; margin-top: 5px; opacity: 0.9;">支持：网易云、QQ音乐、酷狗、酷我</div>
            </button>
        </div>
        <div style="padding: 10px 20px 20px;">
            <button id="cancel-api-selector" style="width: 100%; padding: 12px; background: #f5f5f5; color: #666; border: none; border-radius: 10px; cursor: pointer; font-size: 14px;">取消</button>
        </div>
    </div>
</div>

<!-- 搜索历史弹窗 -->
<div id="search-history-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 500px; max-height: 70vh; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="padding: 15px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h3 style="margin: 0; font-size: 18px;">搜索历史</h3>
                <button id="toggle-delete-mode" style="background: none; border: none; font-size: 14px; cursor: pointer; color: #666; padding: 5px 10px; border-radius: 5px; transition: all 0.2s;">删除</button>
            </div>
            <button id="close-search-history" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #888;">&times;</button>
        </div>
        <div id="search-history-list" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
        <div style="padding: 15px; border-top: 1px solid #f0f0f0; display: flex; gap: 10px;">
            <button id="select-all-history" style="display: none; flex: 1; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">全选</button>
            <button id="delete-selected-history" style="display: none; flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">删除选中</button>
            <button id="clear-search-history" style="flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">清空历史</button>
        </div>
    </div>
</div>

<!-- 音乐搜索弹窗 - 底部滑出 -->
<div id="music-search-modal">
    <div class="music-search-modal">
        <div class="modal-header">
            <h3>搜索音乐</h3>
            <div class="header-buttons">
                <button class="history-btn" id="music-search-history-btn">历史</button>
                <button class="modal-close" id="close-music-search-modal">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="search-input-container">
                <div class="search-box">
                    <input type="text" id="music-search-keyword" placeholder="输入歌曲名或歌手名" />
                    <button class="search-btn-inner" id="music-search-btn">搜索</button>
                </div>
                
                <div class="platform-tabs">
                    <div class="platform-tab active" data-filter="all">全部结果</div>
                    <div class="platform-tab" data-filter="netease">网易云</div>
                    <div class="platform-tab" data-filter="qq">QQ音乐</div>
                    <div class="platform-tab" data-filter="kugou">酷狗</div>
                    <div class="platform-tab" data-filter="kuwo">酷我</div>
                </div>
            </div>
            
            <div id="music-search-status" class="search-status"></div>
            <div id="music-search-results" class="music-search-results"></div>
        </div>
    </div>
</div>

<!-- 页面悬浮歌词 - 纯歌词无背景 -->
<div id="floating-lyrics-container">
    <button class="floating-lyrics-close" id="close-floating-lyrics">&times;</button>
    <div class="floating-lyrics-content" id="floating-lyrics-content">
        <div class="floating-lyric-line">♪ 暂无歌词 ♪</div>
    </div>
</div>

    <script src="script.js"></script>




    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">取消</button>
                <button id="custom-modal-confirm" class="confirm-btn">确定</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden input for Card Import -->
    <input type="file" id="import-card-input" accept=".json,.png" style="display: none;">
    
    <!-- TTS音频播放器 (用于Minimax语音播放) -->
    <audio id="tts-audio-player" style="display: none;"></audio>
</body>

</html>

    </div>
</div>

<!-- 批量清除角色数据模态框 -->
<div id="batch-clear-chat-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">批量清除角色数据</h3>
            <button id="close-batch-clear-modal" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #888;">&times;</button>
        </div>
        
        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
            <p style="margin: 0; font-size: 13px; color: #856404; line-height: 1.5;">
                ⚠️ 此操作将清空选中角色/群聊的所有聊天记录，效果等同于逐个进入聊天点击"清空聊天记录"按钮。
            </p>
        </div>
        
        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="batch-clear-select-all" style="margin-right: 8px; cursor: pointer;">
                <span style="font-weight: 600;">全选</span>
            </label>
            <span style="color: #888; font-size: 14px;" id="batch-clear-count">已选择 0 项</span>
        </div>
        
        <div id="batch-clear-list" style="flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; max-height: 400px;">
            <!-- 角色和群组列表将动态生成 -->
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button id="confirm-batch-clear-btn" class="btn btn-danger" style="flex: 1;">清除选中</button>
            <button id="cancel-batch-clear-btn" class="btn btn-secondary" style="flex: 1;">取消</button>
        </div>
    </div>
</div>

<script src="script.js"></script>
</body>
</html>
