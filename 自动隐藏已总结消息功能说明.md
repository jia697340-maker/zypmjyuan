# 自动隐藏已总结消息功能说明

## 功能概述
新增了"自动隐藏已总结的消息"开关，让用户可以自由选择在自动总结后是否删除已总结的消息。

## 功能特点

### 1. 新增开关
- **位置**：在自动总结设置区域（私聊和群聊都有）
- **默认状态**：关闭
- **说明文字**：开启后，总结完成会自动删除已总结的消息（不发送给AI）。关闭则保留所有消息。

### 2. 行为变化

#### 开关关闭时（默认）
- 自动总结后**不删除**任何消息
- 所有消息都会保留在聊天记录中
- 消息会继续发送给AI
- 提示文字：`已自动总结前 X 条消息（消息已保留）`

#### 开关开启时
- 自动总结后**自动删除**已总结的消息
- 已总结的消息不会发送给AI，节省Token
- 只保留未总结的消息
- 隐藏的楼层范围会记录到 `hiddenMessageRanges` 中
- **在"当前已隐藏"区域显示隐藏的楼层**（如"1-50"）
- 提示文字：`已自动总结前 X 条消息并隐藏（楼层1-X）`

### 3. 适用范围
- ✅ 私聊对话
- ✅ 群聊对话
- ✅ 每个对话可以独立配置

## 使用场景

### 场景1：需要节省Token
开启"自动隐藏已总结的消息"开关，让系统自动删除已总结的消息，只保留总结内容和未总结的消息。

### 场景2：需要保留完整记录
关闭"自动隐藏已总结的消息"开关，系统会保留所有消息，只是生成总结作为参考。

## 技术实现

### 修改的文件
- `index.html`：主要代码文件
- `粘包狗の更新日志.txt`：更新日志

### 核心修改点

1. **HTML界面**（2处）
   - 私聊设置区域添加开关
   - 群聊设置区域添加开关

2. **数据加载**（2处）
   - 私聊设置加载 `autoHideSummarized` 字段
   - 群聊设置加载 `autoHideSummarized` 字段

3. **数据保存**（2处）
   - 私聊设置保存 `autoHideSummarized` 字段
   - 群聊设置保存 `autoHideSummarized` 字段

4. **核心逻辑**（1处）
   - `checkAutoSummary` 函数：根据开关状态决定是否删除消息
   - 删除消息时记录隐藏范围到 `hiddenMessageRanges`
   - 更新"当前已隐藏"区域的显示

## 测试建议

1. **测试私聊**
   - 创建一个私聊对话
   - 开启自动总结，设置条数为5
   - 关闭"自动隐藏已总结的消息"
   - 发送5条以上消息，观察是否保留所有消息
   - 开启"自动隐藏已总结的消息"
   - 再发送5条以上消息，观察是否删除已总结的消息

2. **测试群聊**
   - 创建一个群聊
   - 开启自动总结，设置条数为5
   - 测试开关关闭和开启两种情况

3. **测试独立性**
   - 验证不同对话的开关设置互不影响
   - 验证私聊和群聊的开关设置互不影响

## 兼容性说明

- 旧数据自动兼容：如果 `autoHideSummarized` 字段不存在，默认为 `false`（关闭状态）
- 不影响现有功能：只是在自动总结功能基础上增加了可选的删除行为
