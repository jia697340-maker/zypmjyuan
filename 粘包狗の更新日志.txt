
修复：时间显示不及时问题
优化：消息改成流式输出，不是一次输出多条了
新增：新增后台消息发送，逻辑来源JCY老师，稍加修改
优化：后台消息和聊天消息都移除了消息条数限制，下限为1，上限为100
新增：拉黑功能，逻辑来源JCY老师。
新增：每个角色不同的后台时长和拉黑时长
新增：后台发消息也会新增心声
新增：AI生成CHAR。
新增：AI生成USER预设。
新增：CHAR的NPC库，可以全局和角色之间NPC互通。
优化：角色个人设置的后台活动和API设置后台活动之间的优先级关系
新增：多种群聊玩法。
新增：线下模式功能！
修复：PWA安装问题
新增：外卖选购界面
优化：二改说明和二传说明
新增：共享位置功能（从手16复制，完全兼容章鱼喷墨机UI风格）
优化：共享位置按钮UI美化，添加悬停动画效果
新增：美化的位置输入弹窗，符合章鱼喷墨机UI风格
新增：AI角色可以主动发送位置分享（后台活动支持）
新增：AI角色可以主动分享链接给用户（后台活动支持）
优化：AI可以看到用户分享的链接并做出响应
新增：NPC聊天功能 - 可以直接与NPC库中的NPC对话

新增：旁观者群聊创建功能

修复：旁观者群聊模式下的空指针错误
优化：旁观者群聊功能完善

修复：清空聊天记录时，角色的在线状态现在会重置为默认的"在线"状态
新增：消息支持Markdown格式 - *文字*显示为斜体，**文字**显示为加粗
修复：点击"引用"按钮后，长按菜单现在会自动消失，可以直接开始打字
新增：长按菜单新增"单句重说"功能 - 可以只重新生成某一条AI消息，而不是整轮对话
新增：转账收账和退回后会生成新的转账卡片，显示接收/退回状态，就像微信一样
新增：转账操作面板新增"查看备注"按钮，可以查看完整的转账备注内容

新增：提示词Token分析功能 - 在当前Token数下方新增"查看Token详细"按钮
新增：可查看系统提示词和历史消息各占多少Token
新增：系统提示词各模块（基础规则、时间感知、音乐情景、NPC社交圈等）的Token分布
新增：历史消息中每条消息的Token使用量详细列表
新增：教程中新增"简洁模式(Prompt优化)"说明，帮助用户理解如何优化AI表现
新增：教程中新增"消息数量限制说明"，详细解释Token消耗和记忆轮数的关系
修复：消息发送后输入框立即清空，不再停留几秒，提升用户体验
修复：自动总结功能现在真正调用AI生成总结，而不是简单列出消息
优化：总结内容用连贯的文字叙述重要事情，帮助角色快速了解之前发生了什么
优化：总结中使用对话者的真实名字，不再使用"用户"、"AI"等代称
优化：总结作为长期记忆，大幅节省Token消耗
优化：聊天列表预览不再显示系统提示消息（如撤回消息提示等）
修复：旁观者群聊调用API后显示"输入中"但没有消息的问题
优化：改进旁观者群聊的消息解析fallback逻辑，即使格式不完美也能显示消息

新增：群投票功能（2025-12-14）
新增：相机拍照按钮 - 在相册拉取图片按钮旁新增相机按钮，可直接调用设备相机拍照并识图（2025-12-14）
新增：识别USER头像功能 - 在挂载聊天记录开关上方新增独立开关，开启后CHAR会自动识别USER的头像内容（可能是人物、动物、物品等），并在对话中记住头像的内容。每次更换头像时会自动重新识别，识别结果会添加到系统提示词中供CHAR参考。CHAR会知道这是头像内容，而不是USER本人的真实外貌（2025-12-14）
新增：清除所有头像记忆按钮 - 在识别USER头像功能区域新增"清除所有头像记忆"按钮，可以一键清除所有角色的头像识别记录。适用于关闭识别功能后更换头像的场景，避免CHAR记住旧头像导致对话割裂感（2025-12-14）
新增：情头绑定功能 - 在角色头像库和我的头像库中新增情头绑定管理，可以将角色头像和USER头像绑定为情侣头像对。每个头像只能绑定一个配对头像，支持添加备注描述情头风格。CHAR知道哪些是情头，可以根据对话氛围和情头备注，在合适的时候提议换上情头（2025-12-14）
新增：CHAR换头像能力 - CHAR现在可以帮USER更换头像了！CHAR可以查看USER的头像库和备注，为USER选择合适的头像。也可以给自己和USER同时换上绑定的情头。如果用户绑定了多对不同风格的情头，CHAR能根据备注和对话情境选择最合适的情头（2025-12-14）
新增：页面悬浮歌词功能 - 在一起听播放音乐时，页面上会出现纯歌词悬浮显示，完全透明无背景，不遮挡视线。实时显示当前播放的歌词（约3-4句），当前歌词用粉色高亮显示并带有阴影效果，其他歌词半透明显示。支持丝滑拖动，可以随意移动到页面任意位置。鼠标悬停时显示关闭按钮。点击"返回"按钮退出播放器界面后，悬浮歌词会继续显示在页面上，方便用户边聊天边看歌词。只有在结束一起听会话或手动关闭悬浮歌词时才会隐藏（2025-12-14）
新增：悬浮歌词自定义设置 - 在主屏幕自定义页面底部新增"悬浮歌词设置"区域，可以实时调整：1) 当前歌词字号（14-32px，默认18px）；2) 其他歌词字号（10-24px，默认13px）；3) 显示歌词句数（1-7句，默认3句）；4) 当前歌词颜色（默认粉色#ff80ab）；5) 前一句歌词颜色（默认灰色#787878）；6) 接下来歌词颜色（默认灰色#787878）；7) 歌词上下间隔（0-30px，默认8px）。所有设置支持滑动条实时调整，数值实时显示更新，颜色支持取色器和手动输入十六进制颜色值。每项设置都有独立的重置按钮，也可以一键重置所有设置。设置留空时使用默认值，数据实时保存并立即生效（2025-12-14）
新增：实时时间感知开关 - 在角色设置中新增独立的"实时时间感知"设置区域（蓝色背景框），位于线下模式上方，默认开启。开启时，CHAR能感知到精准的实时时间（格式：2025年12月14日 23:45），包括年月日时分。关闭后，CHAR将完全无法感知时间信息，prompt中不会包含任何时间相关的内容。时间感知是精准的，每次对话都会获取当前的实时时间并传递给AI。该设置对私聊和群聊都生效，是独立于线下模式的全局时间感知设置（2025-12-14）
新增：角色/成员专属Minimax TTS配置 - 现在Minimax语音（TTS）设置支持单个角色和群成员的专属配置了！类似后台活动设置，单个角色/成员的Minimax配置优先级高于全局配置。即使全局没有配置Minimax，只要单个角色/成员开启并配置了专属Minimax TTS，该角色/成员也能使用语音功能。角色和群成员都可以配置完整的Minimax参数（Group ID、API Key、Voice ID、Speech Model），不再局限于只能设置音色。旧的voiceId数据会自动兼容迁移到新结构（2025-12-14）
新增：自动隐藏已总结消息开关 - 在自动总结设置区域新增"自动隐藏已总结的消息"开关，默认关闭。开启后，自动总结完成会自动删除已总结的消息（不发送给AI），节省Token。关闭时，总结后保留所有消息，不做任何改动。私聊和群聊都支持独立配置该开关。总结提示会根据开关状态显示不同的文字（"已隐藏"或"消息已保留"）。自动隐藏时会在"当前已隐藏"区域显示隐藏的楼层范围（如"1-50"），方便用户了解哪些消息被隐藏了（2025-12-16）
修复：Token统计错误 - 修复了"当前Token数"统计不准确的问题。之前统计时没有过滤隐藏的消息，导致Token数虚高（如7条消息显示1万3 Token）。现在Token统计会先过滤掉隐藏范围内的消息，再根据记忆轮数截取，统计结果更准确，反映API实际调用的Token数（2025-12-16）
修复：自动总结条数逻辑 - 修复了自动总结触发逻辑错误。现在设置自动总结条数为100时，会在100、200、300楼等整数倍时触发总结，而不是达到100条就一直触发。第二次及以后的总结会弹窗询问用户是否要包含之前已总结的消息（如200楼时询问是否总结全部200楼还是只总结100-200楼），避免重复总结。用户选择"只总结新消息"时，总结提示会显示具体的楼层范围（如"已自动总结第101-200楼"）（2025-12-17）
优化：自动总结记录机制 - 新增已总结楼层记录功能，系统会记住哪些楼层已经总结过。如果用户在某个触发点（如100楼）已经完成总结，之后即使再次达到该楼层也不会重复提示总结。清空聊天记录时会自动清除已总结记录，确保数据一致性。这样避免了用户取消总结后反复被提示的问题（2025-12-17）
重构：总结功能改为世界书系统 - 移除了记忆库功能，将自动总结和手动总结都改为创建/更新世界书。首次总结时会让用户命名并创建一个关联该角色/群聊的专属总结世界书，之后的每次总结（无论自动还是手动）都会自动追加更新到这个世界书中，每次更新都会标注时间戳。如果总结世界书被用户删除，下次总结时会重新创建一个新的。总结世界书会自动关联到角色/群聊的世界书列表中，AI可以直接读取这些总结内容作为长期记忆（2025-12-17）
删除：完全移除记忆库功能 - 删除了所有记忆库相关的UI、按钮、modal和代码逻辑。移除了`getMemoryLibraryContent`函数和所有调用记忆库的代码。删除了私聊和群聊设置中的"记忆库内容"、"管理删除"、"压缩记忆"等按钮。移除了记忆库modal、删除记忆modal、压缩记忆modal。清理了所有prompt生成函数中的`memoryLibrary`参数和相关逻辑。记忆库功能已完全被世界书系统取代（2025-12-17）

优化：数据存储性能优化，防止闪退（2025-12-18）
- 优化缓存管理：减少最大缓存数量从50降至30，降低内存占用
- 优化内存估算：避免频繁序列化整个缓存导致内存峰值
- 优化数据查询：使用迭代器代替toArray()，避免一次性加载所有数据到内存
- 优化存储信息获取：使用count()和each()代替toArray()，减少内存占用
- 新增自动清理机制：每5分钟自动清理过期缓存，每30分钟强制清空缓存
- 新增内存优化按钮：在教程页面新增"🧹 内存优化"按钮，可手动清空缓存和清理无效数据
- 优化清理算法：使用估算代替实际序列化，避免处理大数据时内存溢出

重大优化：图片存储方式改革，彻底解决闪退问题（2025-12-18）
- 🔥 核心问题：Base64存储图片导致IndexedDB数据库过大（几十MB甚至上百MB），长时间使用后必然闪退
- ✅ 解决方案：改用Blob存储图片，数据库大小减少70%以上
- 新增imageBlobs表：专门存储图片Blob，与文本数据分离
- 新增storeImageAsBlob函数：上传图片时自动转换为Blob存储
- 新增getImageUrl函数：显示图片时自动从IndexedDB获取Blob并创建URL
- 新增自动图片处理：MutationObserver自动监听DOM变化，处理所有blob引用的图片
- 新增"🔄 转换图片存储格式"按钮：一键将旧的Base64图片转换为Blob存储
  - 自动扫描并转换：角色头像、头像库、我的头像库、表情包
  - 显示转换进度和节省的空间大小
  - 转换后建议刷新页面以完全生效
- 兼容性：完全兼容旧版Base64格式，自动识别并正确显示
- 建议：如果遇到闪退，立即点击"转换图片存储格式"按钮，可彻底解决问题

优化：编辑功能对所有类型的消息都可以使用了（2025-12-18）
- 编辑功能现在对所有类型的消息都可用（除了隐藏的系统消息和已撤回消息）
- 包括文本消息、表情包、语音、图片、转账、礼物等所有消息类型
- 用户和AI的消息都可以编辑

优化：查找聊天消息的特殊类别消息必须使用特殊类别的样式（2025-12-18）
- 表情包消息：显示"📦 表情包"徽章，提取并显示表情包内容
- 语音消息：显示"🎤 语音"徽章，提取并显示语音时长
- 图片消息：显示"🖼️ 图片"徽章，提取并显示图片描述或[图片]
- 转账消息：显示"💰 转账"徽章，提取并显示金额和备注（如"100元 - 生日快乐"）
- 礼物消息：显示"🎁 礼物"徽章，提取并显示礼物名称
- 所有特殊消息在搜索结果中都会显示对应的彩色徽章和图标，一目了然

新增：内存优化功能（2025-12-21）
- 在Git仓库同步下方新增独立的"🧹 内存优化"区域（蓝色背景框）
- 点击"立即优化内存"按钮可以：清空所有缓存数据、清理无效数据引用、优化数据库性能、清理临时数据
- 优化完成后显示清理的项目数量和释放的空间大小
- 内存优化不会删除任何聊天记录、角色或设置，只清理缓存和临时数据
- 页面加载时自动进行轻量级内存优化，清理超过1小时的过期缓存
- 完全兼容旧数据，不会出现内存问题导致的闪退BUG
- 建议定期使用，特别是感觉卡顿或使用时间较长时

新增：图片压缩功能（2025-12-21）
- 在内存优化区域下方新增独立的"🖼️ 图片压缩"区域（橙色背景框）
- 实时显示当前图片总数和总大小（MB）
- 可通过滑动条调整压缩质量（10%-100%，默认70%）
- 点击"开始压缩图片"按钮压缩所有图片，有效减少内存占用
- 压缩过程显示实时进度（如"压缩中... 50/100"）
- 压缩完成后显示：成功压缩数量、跳过数量、节省空间大小和百分比
- 压缩后图片容量实时更新，可以看到压缩效果
- 图片不会失效或丢失，只是降低质量以节省空间
- 建议压缩质量：60-80%，既能节省空间又保持较好的显示效果

删除：API设置中的数据库维护功能（2025-12-21）
- 移除了"数据库维护"区域和"清理未使用的图片"按钮
- 移除了相关的事件监听器和清理逻辑代码
- 图片管理改为使用新的"图片压缩"功能，更加实用和安全

优化：悬浮歌词设置持久化（2025-12-21）
- 修复了刷新页面后悬浮歌词设置恢复默认值的问题
- 在loadData函数中添加了深度合并逻辑，确保所有悬浮歌词设置属性都被正确保留
- 现在调整过的歌词设置（字号、颜色、句数、间隔等）会永久保存
- 刷新页面后会自动恢复上次保存的设置，不会重置为默认值

新增：总结世界书精简功能（2025-12-21）
- 在世界书编辑界面的注入位置下方新增"📝 总结精简"区域（蓝色背景框）
- 仅在编辑总结类型世界书时显示，其他类型世界书不显示此功能
- 点击"🗜️ 精简目前总结"按钮可调用API精简总结内容
- 使用与聊天设置中相同的总结提示词，真实调用API进行智能精简
- 精简后保留所有关键信息，删除重复和冗余描述，使用更简洁的语言
- 显示精简前后的字数对比和压缩率
- 精简前会弹窗确认，建议用户先备份原内容
- 精简完成后直接更新文本框内容，用户可以继续编辑或保存

优化：精简总结错误处理（2025-12-21）
- API调用失败时弹出详细错误提示窗口，不再使用默认总结
- 错误提示包含具体错误信息和排查建议
- 检查API设置完整性（URL、密钥、模型）
- 增强API响应数据格式验证
- 失败时保持原内容不变，不会丢失数据

新增：总结进度显示功能（2025-12-21）
- 在自定义总结提示词上方新增"📊 总结进度"显示区域（绿色背景框）
- 实时显示当前消息总数
- 显示最后一次总结的位置（第X条）
- 支持自动总结和手动总结的记录
- 私聊和群聊都有独立的总结进度显示
- 未总结时显示"未总结"，已总结时显示具体位置并高亮
- 每次总结完成后自动更新显示
- 打开聊天设置时自动加载最新的总结进度